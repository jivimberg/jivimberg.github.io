<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Coding Forest]]></title>
  <link href="http://jivimberg.github.io/atom.xml" rel="self"/>
  <link href="http://jivimberg.github.io/"/>
  <updated>2018-08-26T22:20:44-07:00</updated>
  <id>http://jivimberg.github.io/</id>
  <author>
    <name><![CDATA[Juan Ignacio Vimberg]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[JaCoCo &amp; Kotlin: Coverage on Generated Code]]></title>
    <link href="http://jivimberg.github.io/blog/2018/08/12/jacoco-and-kotlin-coverage-on-generated-code/"/>
    <updated>2018-08-12T21:26:43-07:00</updated>
    <id>http://jivimberg.github.io/blog/2018/08/12/jacoco-and-kotlin-coverage-on-generated-code</id>
    <content type="html"><![CDATA[<p>JaCoCo works <em>flawlessly</em> with Kotlin. Except when it reports lines not covered on generated code üò°. Fortunately there‚Äôs a fix already in place.</p>

<!--more-->


<hr />

<h3><em>Update 08/26:</em> <strong>JaCoCo 0.8.2 has now officially been released</strong> üëè No need to use the <em>0.8.2-SNAPSHOT</em> anymore.</h3>

<hr />

<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-08-12/JaCoCo-before.png" width="720" title="‚ÄôJaCoCo before‚Äô" ></p>

<blockquote><p>What!? I didn‚Äôt even write those functions! There‚Äôs no way I‚Äôm writing tests for them. I‚Äôm pretty sure the compiler knows what it‚Äôs doing‚Ä¶</p><footer><strong>Me</strong> <cite>Every Time I Saw the Coverage Report</cite></footer></blockquote>


<p>Good news is that this <a href="https://github.com/goodwinnk">has been fixed</a> in the latest JaCoCo release (thanks to <a href="https://github.com/goodwinnk">goodwink</a>). Bad news is that <strong>0.8.2 is not out yet</strong> üòû</p>

<p>If you are like me, and can‚Äôt wait to get this working, you can <strong>use the SNAPSHOT version of JaCoCo</strong> making this changes on your <code>build.gradle</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">repositories</span> <span class="p">{</span>
</span><span class='line'>  <span class="err">‚Ä¶</span>
</span><span class='line'>  <span class="n">maven</span><span class="p">(</span><span class="s">&quot;https://oss.sonatype.org/content/repositories/snapshots&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">jacoco</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">toolVersion</span> <span class="p">=</span> <span class="s">&quot;0.8.2-SNAPSHOT&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>(I‚Äôm using <a href="https://github.com/gradle/kotlin-dsl">Gradle with Kotlin DSL</a> in this example)</em></p>

<p>Now you can finally take your Kotlin coverage to 100% without having to write tests for <code>component1()</code> and <code>component2()</code>.</p>

<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-08-12/JaCoCo-after.png" width="720" title="‚ÄôJaCoCo after‚Äô" ></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hierarchical Queries on RDBMS With JPA]]></title>
    <link href="http://jivimberg.github.io/blog/2018/08/04/recursive-queries-on-rdbms-with-jpa/"/>
    <updated>2018-08-04T11:29:52-07:00</updated>
    <id>http://jivimberg.github.io/blog/2018/08/04/recursive-queries-on-rdbms-with-jpa</id>
    <content type="html"><![CDATA[<p>Hello! In this post I‚Äôll explore the different alternatives for querying hierarchical data stored on a RDBMS using <a href="http://www.oracle.com/technetwork/java/javaee/tech/persistence-jsp-140049.html">JPA</a>.</p>

<!--more-->


<h1>What are we trying to do?</h1>

<p>Let‚Äôs use a silly example to illustrate what we are trying to achieve. Say we want to model <strong>mother-daughter relationships</strong>, we can do so with an entity like this:</p>

<xmp class="kotlin-code" theme="darcula" data-highlight-only>
import javax.persistence.CascadeType
import javax.persistence.Entity
import javax.persistence.GeneratedValue
import javax.persistence.GenerationType
import javax.persistence.Id
import javax.persistence.OneToMany

//sampleStart
@Entity
data class Woman (
    val name: String,
    @OneToMany(cascade = [CascadeType.ALL]) val daughters: MutableSet<Woman> = mutableSetOf(),
    @Id @GeneratedValue(strategy = GenerationType.AUTO) val id: Long? = null
)
//sampleEnd

\~</xmp>


<p>In OO-talk that‚Äôs just one Type with a reference to itself like this:</p>

<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-08-04/UML.jpg" width="240" title="‚ÄôUML‚Äô" ></p>

<p>And once we start creating a bunch of mothers, we‚Äôll get a <a href="https://en.wikipedia.org/wiki/Directed_acyclic_graph">directed acyclic graph</a>. Although for this example, and to keep things simple, <strong>we‚Äôll just model the offspring of just one single person</strong> so we get a nice tree like this:</p>

<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-08-04/tree.jpg" width="480" title="‚ÄôTree‚Äô" ></p>

<p>But in DB this is stored in <strong>2 tables</strong>. One contains the Woman data and the other one the relationships.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>| Id | Name   |       | Woman_Id |  Daughters_Id | 
</span><span class='line'>|----|--------|       |----------|---------------| 
</span><span class='line'>| 1  | Wendy  |       | 1        | 2             | 
</span><span class='line'>| 1  | Wendy  |       | 1        | 3             | 
</span><span class='line'>| 2  | Brenda |       | 2        | 4             | 
</span><span class='line'>| 2  | Brenda |       | 2        | 5             | 
</span><span class='line'>| 3  | Carol  |       | 3        | 6             | 
</span><span class='line'>| 4  | Linda  |   
</span><span class='line'>| 5  | Betty  |   
</span><span class='line'>| 6  | Lisa   |</span></code></pre></td></tr></table></div></figure>


<p>We‚Äôll focus in just one single type of query, namely:</p>

<blockquote><p><em>Find a node and return the whole subtree underneath</em></p></blockquote>

<p>Or in domain specific terms:</p>

<blockquote><p><em>Find a woman and return her along with her offspring</em></p></blockquote>

<h1>Alternatives</h1>

<p>Let‚Äôs explore our options. For the following examples I‚Äôll be using <a href="https://kotlinlang.org/">Kotlin</a>, <a href="http://projects.spring.io/spring-data/">Spring Data</a>, <a href="http://www.oracle.com/technetwork/java/javaee/tech/persistence-jsp-140049.html">JPA</a>, <a href="http://hibernate.org/">Hibernate</a> and an <a href="https://www.oracle.com/database/index.html">Oracle Database</a>. Thanks to JPA you‚Äôll notice that most of the time <strong>the solutions provided work on whatever you‚Äôve decided to use</strong> (I‚Äôll note it when it‚Äôs not the case). You can use Java instead of Kotlin, Eclipselink instead of Hibernate and MySQL instead of Oracle, and even abandon Spring completely.</p>

<p>Because this is meant to be a formative post <strong>I‚Äôll start with some of the ‚Äúwrong‚Äù approaches first</strong> and explain its downsides. If you‚Äôre in a rush you can just scroll to the bottom üòÉ</p>

<h2>Eager fetching</h2>

<p>The simplest solution is using <a href="https://www.thoughts-on-java.org/entity-mappings-introduction-jpa-fetchtypes/">Eager fetching</a>. We can enable eager fetching specifying the <code>fetch</code> parameter on the <code>@OneToMany</code>  annotation like this:</p>

<xmp class="kotlin-code" theme="darcula" data-highlight-only>
import javax.persistence.CascadeType
import javax.persistence.Entity
import javax.persistence.GeneratedValue
import javax.persistence.GenerationType
import javax.persistence.Id
import javax.persistence.OneToMany

//sampleStart
@Entity
data class Woman (
    val name: String,
    @OneToMany(fetch = FetchType.EAGER, cascade = [CascadeType.ALL]) val daughters: MutableSet<Woman> = mutableSetOf(),
    @Id @GeneratedValue(strategy = GenerationType.AUTO) val id: Long? = null
)
//sampleEnd

</xmp>


<p>Great, it works! But wait, <em>why do I see so many SELECT calls to the database?</em> As you‚Äôve probably figured out the issue with this approach is that it falls in the <a href="https://stackoverflow.com/questions/97197/what-is-the-n1-select-query-issue">N + 1 SELECT problem</a>.</p>

<p>Some authors even go as far as considering <a href="https://vladmihalcea.com/eager-fetching-is-a-code-smell/">eager fetching a <strong>code smell</strong></a>. In the words of <a href="https://vladmihalcea.com/about/">Vlad Mihalcea</a> (emphasis mine):</p>

<blockquote><p>The EAGER fetching strategy is a code smell. Most often it‚Äôs used for simplicity sake without considering the long-term performance penalties. The fetching strategy <strong>should never be the entity mapping responsibility</strong>. Each business use case has different entity load requirements and therefore the fetching strategy should be delegated to each individual query.</p></blockquote>

<h2>Using <code>join fetch</code></h2>

<p>Another alternative would be to use <code>join fetch</code> as part of the JPQL query.</p>

<xmp class="kotlin-code" theme="darcula" data-highlight-only>
fun findWomanUsingJoinFetch(id: Long): Woman? {
        return em.createQuery("select distinct w from Woman w left join fetch w.daughters", Woman::class.java)
        .resultList
        .find { it.id == id }
}
</xmp>


<p>With <code>join fetch</code> we can tell JPA to do a <code>join</code> to execute the query and also include the data as part of the response object when mapping to the OO world.</p>

<p>The <em>huge downside</em> is that we‚Äôre actually <strong>querying ALL women</strong>  and only then selecting the one we were looking for from the <code>resultList</code>. This means that, unless you‚Äôre querying for the root node, <strong>you‚Äôll always be doing extra work</strong>.</p>

<p>And no, a <code>where</code> clause can‚Äôt help us here. Using <code>where w.id = :id</code> would leave us with just the root and one level of descendants in the <em>resultList</em>.</p>

<p>Unfortunately <strong>I couldn‚Äôt find a way of making this a single JPQL query</strong>.  <a href="https://vladmihalcea.com/about/">Vlad Mihalcea</a> has a <a href="https://vladmihalcea.com/hibernate-facts-multi-level-fetching/">great article</a> explaining how to use <code>join fetch</code> to query all the leaves of the tree and then build the associations all the way up the entity hierarchy. Sadly we can‚Äôt apply the same approach here because we‚Äôre querying a <em>multi-level homogeneous tree</em>. That means that <strong>all the nodes are of the same type, and thus mapped to the same table,</strong> and furthermore leaves can be N levels deep. So if we try Vlad‚Äôs approach we‚Äôd end up with the similar <strong><code>where</code> problem</strong> mentioned above.</p>

<h2>Entity graph</h2>

<p>Another proposed solution is to use <a href="https://docs.oracle.com/javaee/7/tutorial/persistence-entitygraphs001.htm">Entity Graphs</a> introduced in <em>JPA 2.1</em>. You can use Entity Graphs as a query hint to <strong>specify which fields you want eagerly fetched as part of the query</strong>.</p>

<blockquote><p>Entity graphs have attributes that correspond to the fields that will be eagerly fetched during a find or query operation</p></blockquote>

<p>They come in 2 flavors. Static through annotations:</p>

<xmp class="kotlin-code" theme="darcula" data-highlight-only>
import javax.persistence.CascadeType
import javax.persistence.Entity
import javax.persistence.FetchType
import javax.persistence.GeneratedValue
import javax.persistence.GenerationType
import javax.persistence.Id
import javax.persistence.NamedAttributeNode
import javax.persistence.NamedEntityGraph
import javax.persistence.NamedEntityGraphs
import javax.persistence.NamedSubgraph
import javax.persistence.OneToMany

//sampleStart
@Entity
@NamedEntityGraphs(
    NamedEntityGraph(name = "womanWithDaughters",
        attributeNodes = [NamedAttributeNode(value = "daughters", subgraph = "daughterWithDaughters")],
        subgraphs = [
            NamedSubgraph(
                name = "daughterWithDaughters",
                attributeNodes = [NamedAttributeNode("daughters")]
            )
        ]
    )
)
data class Woman (
//sampleEnd
    val name: String,
    @OneToMany(fetch = FetchType.EAGER, cascade = [CascadeType.ALL]) val daughters: MutableSet<Woman> = mutableSetOf(),
    @Id @GeneratedValue(strategy = GenerationType.AUTO) val id: Long? = null
)
</xmp>


<p>Or you can construct the graph <strong>programmatically</strong> to have some more flexibility:</p>

<xmp class="kotlin-code" theme="darcula" data-highlight-only>
fun findWomanUsingEntityGraph(id: Long): Woman {
    val graph = em.createEntityGraph(Woman::class.java)
        .also { it.addSubgraph<Woman>("daughters") }
    return em.find(Woman::class.java, id, mapOf("javax.persistence.loadgraph" to graph))
}
</xmp>


<p>I thought: <em>‚ÄúThis is it IT! If I can manually build the graph for each query I can even specify how many levels deep I want to go‚Äù</em>. But once again, it didn‚Äôt quite work üòû</p>

<p>I tried creating graphs with subgraphs N levels deep but <strong>the query would just ignore them and only fetch up to 2 levels</strong>. From the annotations flavor this limitation is clear since:</p>

<ol>
<li>You can‚Äôt use a subgraph reference on an attribute of the same graph recursively (it‚Äôll fail at runtime)</li>
<li>And <code>@NamedSubgraph</code> can‚Äôt have other <code>subgraphs</code> defined underneath.</li>
</ol>


<p>I was hoping this would be possible through the API, but apparently it‚Äôs not. Maybe Hibernate is to blame here, I don‚Äôt really know‚Ä¶ But <em>I couldn‚Äôt find any documentation beyond the basic 2 level example</em>.</p>

<h2>Using <code>@BatchSize</code></h2>

<p>Going back to the Eager Fetch approach, we hated it because it resulted in N queries where N is the number of Women in the table. <strong>With  <code>@BatchSize</code> we can mitigate this</strong>.</p>

<xmp class="kotlin-code" theme="darcula" data-highlight-only>
data class Woman(
    val name: String,
    @BatchSize(size = 10)
    @OneToMany(fetch = FetchType.EAGER, cascade = [CascadeType.ALL]) val daughters: MutableSet<Woman> = mutableSetOf(),
    @Id @GeneratedValue(strategy = GenerationType.AUTO) val id: Long? = null
)
</xmp>


<p>By setting the batch size to 10 we‚Äôre basically saying: <em>‚ÄúSince you‚Äôre going to the DB to execute a query bring up to 10 elements instead of just one‚Äù</em>. Effectively <strong>reducing the number of roundtrips to the database</strong>.</p>

<p><code>@BatchSize</code> is a <a href="https://docs.jboss.org/hibernate/orm/5.3/javadocs/org/hibernate/annotations/BatchSize.html">Hibernate specific annotation</a> but on Eclipselink you can use <a href="http://www.eclipse.org/eclipselink/documentation/2.5/jpa/extensions/q_batch_size.htm"><code>eclipselink.batch.size</code></a> to achieve the same result. In fact, remember that as a rule of thumb  <strong>it‚Äôs better to apply this kind of configurations to the query</strong> instead of using an annotation on the entity.</p>

<h2>Connect by (Best solution!)</h2>

<p>If you‚Äôre using Oracle then we can solve this using a native query with <a href="https://docs.oracle.com/cd/B19306_01/server.102/b14200/queries003.htm"><code>CONNECT BY</code></a>. Turns out this clause was created specifically for <strong>selecting rows in hierarchical order</strong>.</p>

<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-08-04/connectby.gif" title="‚ÄôConnect by syntax‚Äô" ></p>

<p>We use <code>START¬†WITH</code> to specify the root node of the hierarchy, and then <code>CONNECT¬†BY</code> to specify the relationship between rows. Our query would look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="n">w</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">w</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">wd</span><span class="p">.</span><span class="n">daughters_id</span>
</span><span class='line'><span class="k">FROM</span> <span class="n">woman</span> <span class="n">w</span>
</span><span class='line'><span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">woman_daughters</span> <span class="n">wd</span> <span class="k">ON</span> <span class="n">w</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">wd</span><span class="p">.</span><span class="n">woman_id</span>
</span><span class='line'><span class="k">START</span> <span class="k">WITH</span> <span class="n">w</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="o">?</span><span class="mi">1</span>
</span><span class='line'><span class="k">CONNECT</span> <span class="k">BY</span> <span class="k">PRIOR</span> <span class="n">wd</span><span class="p">.</span><span class="n">daughters_id</span> <span class="o">=</span> <span class="n">w</span><span class="p">.</span><span class="n">id</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note how in the <code>CONNECT BY</code> clause we use <code>PRIOR</code> to refer to the parent row.</p>

<p>This achieves exactly what we want <strong>in just one query!</strong>. But this doesn‚Äôt come for free. By using native queries we are stepping out of the <em>JPA magical world‚Ñ¢</em>. This means that what the query returns is not an object but a list of rows of the form:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>| Id | Name   | Daughters_id | 
</span><span class='line'>|----|--------|--------------| 
</span><span class='line'>| 1  | Wendy  | 2            | 
</span><span class='line'>| 1  | Wendy  | 3            | 
</span><span class='line'>| 2  | Brenda | 4            | 
</span><span class='line'>| 2  | Brenda | 5            | 
</span><span class='line'>| 3  | Carol  | 6            | 
</span><span class='line'>| 4  | Linda  | null         | 
</span><span class='line'>| 5  | Betty  | null         | 
</span><span class='line'>| 6  | Lisa   | null         |</span></code></pre></td></tr></table></div></figure>


<p>So we‚Äôll have to write the code to transform this back to our domain model. To achieve this I used the <code>@SqlResultSetMapping</code> to model the native query result.</p>

<xmp class="kotlin-code" theme="darcula"data-highlight-only>
    import javax.persistence.CascadeType
import javax.persistence.ColumnResult
import javax.persistence.ConstructorResult
import javax.persistence.Entity
import javax.persistence.EntityManager
import javax.persistence.GeneratedValue
import javax.persistence.GenerationType
import javax.persistence.Id
import javax.persistence.OneToMany
import javax.persistence.SqlResultSetMapping

//sampleStart
data class WomanWithRef(
    val id: Long,
    val name: String,
    val fieldsId: Long?
)

@Entity
@SqlResultSetMapping(
    name = "WomanWithRef",
    classes = [
        ConstructorResult (
            targetClass = WomanWithRef::class,
            columns = [
                ColumnResult(name = "id", type = Long::class),
                ColumnResult(name = "name", type = String::class),
                ColumnResult(name = "daughters_id", type = Long::class)
            ]
        )
    ]
)
data class Woman(
    val name: String,
    @OneToMany(cascade = [CascadeType.ALL]) val daughters: MutableSet<Woman> = mutableSetOf(),
    @Id @GeneratedValue(strategy = GenerationType.AUTO) val id: Long? = null
)
//sampleEnd

</xmp>


<p>And we can finally write the query like this:</p>

<xmp class="kotlin-code" theme="darcula"data-highlight-only>
//sampleStart
fun findTypeWithConnectBy(id: Long): Woman {
    val results: List<WomanWithRef> = em.createNativeQuery(
        """   
            SELECT w.id, w.name, wd.daughters_id
            FROM woman w
            LEFT JOIN woman_daughters wd ON w.id = wd.woman_id
            START WITH w.id = ?1
            CONNECT BY PRIOR wd.daughters_id = w.id
        """.trimIndent(), "TypeWithRefMapping")
        .setParameter(1, id)
        .resultList as List<WomanWithRef>
    return buildGraph(results, id)
}

//sampleEnd
fun buildGraph(queryResult: List<WomanWithRef>, id: Long): Woman {
    val rows = queryResult { it.id == id }
    val firstRow = rows.first()

    val fields = if (rows.size == 1 && firstRow.daughterId == null) {
        mutableSetOf()
    } else {
        rows.mapNotNull { it.daughterId }
            .map { buildGraph(queryResult, it) }
            .toMutableSet()
    }

    return Woman(firstRow.name, fields, id)
}

</xmp>


<p>Using the <code>buildGraph</code> function to traverse the query result and reconstruct the root <code>Woman</code> object.</p>

<p>If you‚Äôre using <code>HibernateCallback</code> here‚Äôs another way of writing the result mapping: <a href="https://docs.spring.io/spring/docs/2.0.x/javadoc-api/org/springframework/orm/hibernate/HibernateCallback.html">https://docs.spring.io/spring/docs/2.0.x/javadoc-api/org/springframework/orm/hibernate/HibernateCallback.html</a></p>

<p><strong>If you‚Äôre not using Oracle</strong> (or some other DB that supports <code>CONNECT BY</code>) you can do recursive queries using <a href="https://en.wikipedia.org/wiki/Hierarchical_and_recursive_queries_in_SQL#Common_table_expression">Common Table Expression (CTE)</a> to achieve a similar result.</p>

<h1>Is RDBMS right for you?</h1>

<p>If you find yourself bending over backwards to make this graph-like queries work, or if you need a query language that will let you express something like:</p>

<blockquote><p><em>Find all women whose great-grandmother is named Carol and have at least one descendant named Brenda</em></p></blockquote>

<p>Then <strong>maybe you should consider your options beyond RDBMS</strong>. You can take a look at graph databases such as <a href="https://neo4j.com/">Neo4j</a> and get familiar with it‚Äôs <a href="https://neo4j.com/developer/cypher-query-language/">query language</a>. Or, if you‚Äôre not ready to make the jump but want to explore a graph API on top of your relational data you should take a look at <a href="http://www.oracle.com/technetwork/database/options/spatialandgraph/overview/index.html">Oracle Spatial and Graph</a>.</p>

<hr />

<p><em>Phew!</em> that was a long one‚Ä¶ Hope you find it useful!</p>

<p>If you know of a better way of doing this kind of queries I‚Äôd love to hear about it, leave me a comment down hereüëá or just <a href="https://twitter.com/jivimberg">ping me on Twitter</a>.</p>

<script src="https://unpkg.com/kotlin-playground@1" data-selector=".kotlin-code"></script>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Book Recommendations: Migrating to Cloud-Native Application Architectures]]></title>
    <link href="http://jivimberg.github.io/blog/2018/07/24/book-recommendations-migrating-to-cloud-native-application-architectures/"/>
    <updated>2018-07-24T16:18:45-07:00</updated>
    <id>http://jivimberg.github.io/blog/2018/07/24/book-recommendations-migrating-to-cloud-native-application-architectures</id>
    <content type="html"><![CDATA[<p>Complementing <a href="https://jivimberg.io/blog/2018/05/25/book-recomendations-migrating-to-microservices-databases/">my last book recommendation</a> on <em>¬†Migrating to microservices databases</em> by <a href="https://twitter.com/yanaga">Edson Yanaga</a> now I present <a href="https://content.pivotal.io/ebooks/migrating-to-cloud-native-application-architectures"><em>Migrating to Cloud-Native Application Architectures</em></a> by <a href="@mstine">Matt Stine</a>.</p>

<!--more-->


<p><a href="https://content.pivotal.io/ebooks/migrating-to-cloud-native-application-architectures"><img class="center" src="http://jivimberg.github.io/images/posts/2018-07-28/cover.jpg" title="‚ÄôMigrating to Cloud-Native Application book cover‚Äô" ></a></p>

<p>I‚Äôm really digging this O‚ÄôReilly booklet style! They <strong>condense a good overview of a specific topic in one-sitting books</strong>. While at the same time provide enough links and resources to keep you digging for a few afternoons if interested.</p>

<p>Matt‚Äôs book is divided in 3 parts. The first bit <strong>‚ÄùThe rise of cloud service‚Äù</strong> serves as an introduction to the topic. It defines <em>cloud native architectures¬†</em> key characteristics and <strong>why you might consider using one</strong>.  If you are already familiar with the subject you may want to skim through this first section.</p>

<p>The second part is the one I enjoyed the most. It talks about <strong>the changes needed to go cloud native</strong>. It covers areas that are sometimes forgotten or considered as an afterthought such as <em>team collaboration</em>, <em>organizational changes</em> (the <a href="https://www.thoughtworks.com/radar/techniques/inverse-conway-maneuver">Inverse Conway Maneuver</a>) and the <em>decentralization of decision making</em>. The rest of the chapter touches on the <strong>technical challenges</strong> required. It was really nice to see a bit on how to <strong>use <a href="https://en.wikipedia.org/wiki/Domain-driven_design">DDD</a> to identify service boundaries</strong> when decomposing data models.</p>

<p>On the last chapter, called <strong>Migration Cookbook</strong>, Matt explores different strategies for decomposing the monolith (such as <em>‚Äùstrangling the monolith‚Äù</em>, <em>‚Äùnew features as Micro-services‚Äù</em>, <em>‚Äùanti-corruption layer‚Äù</em>, etc.) and provides links to articles by companies that applied this strategies on their own systems. The book finishes with a section called <strong>Distributed system recipes</strong>  where some of the more common <em>‚Äúchallenges‚Äù</em> of a cloud-native architecture are explored and particular solutions are presented using <a href="http://projects.spring.io/spring-cloud/">Spring Cloud</a> and <a href="https://netflix.github.io/">Netflix OSS</a>. Here you‚Äôll find things like <em>service discovery</em>, <em>versioned configuration</em>, <em>load balancing</em>, etc. Each topic is presented with a brief description of the problem, a mention of the Netflix OSS solution (and it‚Äôs features) and a code snippet showing how to integrate it with Spring.</p>

<h2>Bottom line</h2>

<p><strong>GO READ IT!</strong> It won‚Äôt take you more than an afternoon and chances are you‚Äôll learn something new. You‚Äôll walk away with <strong>a better understanding of the cloud-native landscape.</strong></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Map.merge]]></title>
    <link href="http://jivimberg.github.io/blog/2018/07/20/map-dot-merge/"/>
    <updated>2018-07-20T07:32:49-07:00</updated>
    <id>http://jivimberg.github.io/blog/2018/07/20/map-dot-merge</id>
    <content type="html"><![CDATA[<p>Sometimes is the small things‚Ä¶ Like finding a new method that does exactly what you were needing.</p>

<!--more-->


<p>Let‚Äôs say I‚Äôm trying to build a book index. In case you haven‚Äôt touch an actual, physical, <em>dead-tree</em> book in a while here‚Äôs what an index looks like<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>:</p>

<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-07-20/index.gif" title="'Discoverability'" ></p>

<p>One way of doing this would be to <strong>build a map of: <em>terms</em> to <em>a list of comma separated pages</em></strong>. This is, by no means, the best way of modeling an index, but it‚Äôll serve our purpose of illustrating the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#merge-K-V-java.util.function.BiFunction-"><code>Map.merge</code></a> method.</p>

<p>Up until yesterday I‚Äôd have written such code like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Index</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">termToPagesMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addWord</span><span class="o">(</span><span class="n">String</span> <span class="n">term</span><span class="o">,</span> <span class="kt">int</span> <span class="n">page</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">final</span> <span class="n">String</span> <span class="n">newPage</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">page</span><span class="o">);</span>
</span><span class='line'>      <span class="kd">final</span> <span class="n">String</span> <span class="n">pages</span> <span class="o">=</span> <span class="n">termToPagesMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">term</span><span class="o">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">pages</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">termToPagesMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">term</span><span class="o">,</span> <span class="n">newPage</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">termToPagesMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">term</span><span class="o">,</span> <span class="n">pages</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">newPage</span><span class="o">));</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>But today I know better!</strong> With <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#merge-K-V-java.util.function.BiFunction-"><code>Map.merge</code></a> I can achieve the same result in just 1 line:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Index</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">termToPagesMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addWord</span><span class="o">(</span><span class="n">String</span> <span class="n">term</span><span class="o">,</span> <span class="kt">int</span> <span class="n">page</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">termToPagesMap</span><span class="o">.</span><span class="na">merge</span><span class="o">(</span><span class="n">term</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">page</span><span class="o">),</span> <span class="o">(</span><span class="n">pages</span><span class="o">,</span> <span class="n">newPage</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">pages</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">newPage</span><span class="o">));</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Basically we provide:</p>

<ul>
<li>The entry <strong>key</strong></li>
<li>A <strong>value</strong> to be used if there was no associated value to the key (or it was <code>null</code>)</li>
<li>A <strong>¬†remapping function</strong> that takes the <strong>old value</strong>, the <strong>new value</strong> and calculates the new value for the map</li>
</ul>


<h2>Bonus track: Removal</h2>

<p>There‚Äôs one more trick you can do with <code>Map.merge</code>. Citing the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#merge-K-V-java.util.function.BiFunction-">documentation</a>:</p>

<blockquote><p>If the function returns¬†<code>null</code>¬†the mapping is removed</p></blockquote>

<p>Something to keep in mind in case it comes in handy in the future. Or if you find yourself debugging an issue of <em>‚Äùvanishing entries on a Map‚Äù</em>, then maybe you should check your <strong>¬†remapping function</strong> üòâ</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>I‚Äôm aware that ebooks have indexes too, but who the fuck uses them when you can do a full blown text search<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Writing Githooks in Kotlin]]></title>
    <link href="http://jivimberg.github.io/blog/2018/07/03/writing-githooks-in-kotlin/"/>
    <updated>2018-07-03T19:45:28-07:00</updated>
    <id>http://jivimberg.github.io/blog/2018/07/03/writing-githooks-in-kotlin</id>
    <content type="html"><![CDATA[<p>You‚Äôre already using Kotlin on your codebase. Maybe, you‚Äôve even migrated to the new <a href="https://github.com/gradle/kotlin-dsl">Kotlin DSL for Gradle</a>. Wouldn‚Äôt it be nice if you could use Kotlin for your <a href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks">git hooks</a> too?</p>

<!--more-->


<p><strong>Well, turns out you can!</strong> Here‚Äôs how you do it‚Ä¶</p>

<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-07-04/captain-hook.png" title="‚ÄôCaptain githook‚Äô" ></p>

<h2>What do I need?</h2>

<p>Git will basically run whatever script you drop on the <code>.git/hooks</code> directory. In their words:</p>

<blockquote><p>To enable a hook script, put a file in the¬†hooks¬†subdirectory of your <code>.git</code> directory that is named appropriately (without any extension) and is executable</p></blockquote>

<p>So all we need is to be able to execute Kotlin files as scripts. There is a <a href="https://github.com/Kotlin/KEEP/blob/scripting/proposals/scripting-support.md">Kotlin Scripting Support KEEP</a> under definition. But for the time being <strong>we‚Äôll stick with the awesome <a href="https://github.com/holgerbrandl/kscript">KScript library</a> (by <a href="https://github.com/holgerbrandl">@holgerbrandl</a>)</strong> that enables Kotlin scripting on <em>*nix-based</em> systems.</p>

<p>You can find the details for installing KScript <a href="https://github.com/holgerbrandl/kscript#installation">here</a>. On MacOS if you‚Äôre using <a href="https://brew.sh/">Homebrew</a> all you have to do is run: <code>brew install holgerbrandl/tap/kscript</code>.</p>

<p>I‚Äôll also be using <strong>Gradle</strong> to automatically install the githook and run the proper validation, but the same can be done with <strong>Maven</strong>.</p>

<h2>The script</h2>

<p>As an example I‚Äôm going to show how to do a <strong>pre-push client hook</strong> that aborts the push if <code>grade check</code> task is not successful. For this I‚Äôve created a file named <code>Pre-Push.kts</code>:</p>

<xmp class="kotlin-code" data-highlight-only>
//sampleStart
#!/usr/bin/env kscript

import java.io.File

println("${Constants.SCRIPT_LOG_TAG} Running pre-push hook")
val hasStashed = stash()
if (hasStashed) {
    println("${Constants.SCRIPT_LOG_TAG} Stashing uncommited changes")
}

val checkExistStatus = runCheck()

if (hasStashed) {
    println("${Constants.SCRIPT_LOG_TAG} Unstashing your changes")
    unstash()
}

val exitValue = when {
    checkExistStatus != Constants.SUCCESS_EXIT_VALUE -> {
        println("${Constants.SCRIPT_LOG_TAG} Gradle check failed. I'm sorry but you can't continue with your push")
        Constants.ERROR_EXIT_VALUE
    }
    else -> {
        println("${Constants.SCRIPT_LOG_TAG} Everything went fine. You can continue with your push")
        Constants.SUCCESS_EXIT_VALUE
    }
}

kotlin.system.exitProcess(exitValue)
//sampleEnd

fun runCheck(): ExitStatus {
    println("${Constants.SCRIPT_LOG_TAG} Running gradle check")
    return "gradle check".runCommandWithRedirect()
}

fun stash(): Boolean {
    val stashOutput = """git stash push --include-untracked -m "stash created by pre-push hook"""".runCommand()
    return stashOutput.firstOrNull() != Constants.NOTHING_TO_STASH_MSG
}

fun unstash() = "git stash pop -q".runCommand()

fun String.runCommand(dir: File? = null): Sequence<String> =
    ProcessBuilder("/bin/sh", "-c", this)
        .redirectErrorStream(true)
        .directory(dir)
        .start()
        .inputStream.bufferedReader().lineSequence()

// Redirecting output and error to stdout
fun String.runCommandWithRedirect(dir: File? = null): ExitStatus =
    ProcessBuilder("/bin/sh", "-c", this)
        .redirectErrorStream(true)
        .inheritIO()
        .directory(dir)
        .start()
        .waitFor()

object Constants {
    const val SCRIPT_LOG_TAG = "Pre-push -"
    const val NOTHING_TO_STASH_MSG = "No local changes to save"
    const val SUCCESS_EXIT_VALUE = 0
    const val ERROR_EXIT_VALUE = -1
}

typealias ExitStatus = Int
</xmp>


<p>The first line is all the <em>magic incantation</em> we need to execute the script. By setting the shebang to <code>#!/usr/bin/env kscript</code> we get to use <code>kscript</code> as <a href="https://github.com/holgerbrandl/kscript#interpreter-usage">interpreter for the script</a>.</p>

<p>The code after the import is <strong>the actual script</strong>. Those are the lines that are going to be executed as soon as somebody calls the script. <em>Just as you‚Äôd expect with any regular shell script.</em></p>

<p>In a nutshell this is what the script does:</p>

<ol>
<li>Stash uncommitted changes <em>if any</em><sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></li>
<li>Run code validation (in this case <code>gradle check</code>)</li>
<li>Unstash possible changes stashed on <em>step 1</em></li>
<li>Log outcome and set the proper exit value</li>
</ol>


<p>The last step is important because <strong>if the script exits to anything other than 0 then git aborts the action</strong> (in this case the push).</p>

<h3>How do I call things from a script?</h3>

<p>To do anything useful on your script you‚Äôll probably have to <strong>call some external tool</strong> at some point. In this particular case for example a mix of <em>git commands</em> and <em>gradle tasks</em>.</p>

<p>There are 2 ways you can go about this:</p>

<ol>
<li>Either <strong>use a Kotlin/Java library</strong> for the task you‚Äôre trying to accomplish (in this example we could use <a href="https://www.eclipse.org/jgit/">JGit</a> and <a href="https://docs.gradle.org/current/userguide/embedding.html">Gradle tooling API</a>)</li>
<li>Or <strong>call a shell command</strong> directly</li>
</ol>


<p>While the first approach is more <strong>portable</strong>, it will introduce some dependencies to your script (which fortunately <a href="https://github.com/holgerbrandl/kscript#declare-dependencies-with-deps">KScript has great support for</a>). On the other hand the second option is probably <strong>easier to implement</strong> because it‚Äôs just using the same commands we use everyday on our workflow.</p>

<p>Since I can assume everybody in my team has <code>git</code> and <code>gradle</code> installed and in their path <strong>I went for option 2</strong>.</p>

<h3>Running shell commands from Kotlin</h3>

<p>We can run shell commands on Kotlin using <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/ProcessBuilder.html"><code>ProcessBuilder</code></a>, just like we‚Äôd do from Java.</p>

<p>In this case I‚Äôve created a <code>runCommandWithRedirect</code> extension function that looks like this:</p>

<xmp class="kotlin-code" data-highlight-only>
import java.io.File

//sampleStart
fun String.runCommandWithRedirect(dir: File? = null): ExitStatus {
        return ProcessBuilder("/bin/sh", "-c", this)
            .redirectErrorStream(true)
            .inheritIO()
            .directory(dir)
            .start()
            .waitFor()
}

//sampleEnd
typealias ExitStatus = Int
</xmp>


<p>This function can be called on any String like this:</p>

<p><code>"gradle check".runCommandWithRedirect()</code></p>

<p>This function will:</p>

<ol>
<li>Redirect the standard and error output to the one for the current process, in our case that means <strong>the output of the command will be visible on the terminal when the githook is executed</strong>.</li>
<li>Set the directory to the passed <code>dir</code> parameter, or use the current directory if no parameter is provided.</li>
<li>Execute the command, wait for it to finish and return the <code>ExitStatus</code></li>
</ol>


<p>You can play around with the different <code>ProcessBuilder</code> options. In my script above for example I‚Äôve another version of this function called <code>runCommand</code> that  <strong>executes the command and returns it‚Äôs output as a <code>Sequence&lt;String&gt;</code></strong>.</p>

<h2>Automatic installation</h2>

<p>Githooks are great to enforce code quality practices (i.e. <em>‚ÄùYou can‚Äôt push if your coverage is less than 80% ‚Äú</em> üëÆ). But for the client-side githook to be execute it needs to be in the <code>.git/hooks</code> folder which is not versioned. That means that <strong>each developer on your team has to manually install the hook</strong>, which means that you are again, relying on the good memory of your teammates to enforce code quality.</p>

<p>Instead we could use <a href="https://gist.github.com/KenVanHoeylandt/c7a928426bce83ffab400ab1fd99054a">this trick</a>. We can create a <em>gradle task</em> called <em>‚Äúcopy‚Äù</em> that copies the githook from the <code>src</code> folder to the <code>git/hooks</code> and removes the file extension in the process.</p>

<p>Then we can make the <em>‚Äúbuild‚Äù</em> task depend on this new <em>‚Äùcopy‚Äù</em> task. <strong>The next time the developer runs <code>gradle build</code> the githook will be installed</strong>. And as a bonus:  the githook script is now versioned too! <sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup></p>

<p>Here‚Äôs how this would look like (using <a href="https://github.com/gradle/kotlin-dsl">Kotlin DSL for Gradle</a>)</p>

<xmp class="kotlin-code" data-highlight-only>
tasks {
    "copy"(Copy::class) {
        from("src/main/kotlin/io/jivimberg/githook/pre-push.kts") {
            rename { it.removeSuffix(".kts") }
        }
        into(".git/hooks")
    }

    "build" {
        dependsOn("copy")
    }
}
</xmp>


<p>‚ö†Ô∏è Don‚Äôt forget to do <code>chmod u+x Pre-Push.kts</code> to make the script runnable, otherwise it won‚Äôt work.</p>

<h2>What about performance?</h2>

<p>Kotlin is a compiled language, so at some point your script will have to be compiled. Fortunately thanks to KScript <strong>this only happens the first time you run the script</strong> and it‚Äôs only compiled again if the script changes.</p>

<p>Other than that there‚Äôs the JVM startup time which adds <strong>around 200ms of overhead</strong>. Maybe in the future we‚Äôll be able to use <a href="https://kotlinlang.org/docs/reference/native-overview.html">Kotlin Native</a> to compile to native binaries directly and avoid this overhead.</p>

<p>If you want to read more about performance comparison between <em>Python</em> and <em>Kotlin</em> scripts check the <a href="https://github.com/holgerbrandl/kscript#what-are-performance-and-resource-usage-difference-between-scripting-with-kotlin-and-python">KScript documentation</a>.</p>

<h2>Bonus track: testing</h2>

<p>Testing Kotlin scripts turned out <strong>not to be so straight forward.</strong></p>

<p><a href="https://proandroiddev.com/testing-kotlin-scripts-42bbbbe09ae5">This article</a> suggests using a <code>runCommand</code> method similar to the one described above to execute the script and check it‚Äôs outputs. Whereas <a href="https://github.com/holgerbrandl/kscript/blob/master/test/TestsReadme.md">KScript own tests</a> are written using <a href="https://github.com/lehmannro/assert.sh">assert.sh</a>.</p>

<p>Neither approach convinced me. I was just looking for a way of <strong>individually test the functions</strong> in my script <strong>using the same tools I use to test the other parts of my code</strong>.</p>

<p>So what I ended up doing was moving all the <em>Pre-Push</em> logic to a regular <code>*.kt</code> file. And then simply creating a <code>*kts</code> Kotlin script that calls my class using the <a href="https://github.com/holgerbrandl/kscript#ease-prototyping-with-include"><code>//INCLUDE</code> KScript directive</a>.</p>

<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-07-04/testing-githook-kotlin.png" title="‚ÄôTesting githook‚Äô" ></p>

<p>The downside is that I know have 2 files for my githook (a <code>*.kt</code> and a <code>*.kts</code>) but that seems <strong>a small price to pay for being able to easily test my code</strong>.</p>

<h1>Conclusion</h1>

<p>Writing githooks in Kotlin is possible and not that hard thanks to <a href="https://github.com/holgerbrandl/kscript">KScript</a>. <strong>You‚Äôll be glad you have tried it out</strong> the next time you have to refactor that <em>pre-push</em> hook.</p>

<p>You can find an <strong>example repository</strong> containing all the code for this blogpost here: <a href="https://github.com/jivimberg/kotlin-githook">https://github.com/jivimberg/kotlin-githook</a></p>

<script src="https://unpkg.com/kotlin-playground@1" data-selector=".kotlin-code"></script>



<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>because you want to verify only on the changes that are going to be pushed<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>And it can even be subject to the same quality standards enforced by the githook itself. INCEPTION!<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Oracle, JPA and the Mystery of the String That Was Null]]></title>
    <link href="http://jivimberg.github.io/blog/2018/06/23/oracle-jpa-and-the-mistery-of-the-string-that-was-null/"/>
    <updated>2018-06-23T10:34:26-07:00</updated>
    <id>http://jivimberg.github.io/blog/2018/06/23/oracle-jpa-and-the-mistery-of-the-string-that-was-null</id>
    <content type="html"><![CDATA[<p>This is the story of how Oracle DB was messing up Kotlin‚Äôs type system, and what I did to fix it.</p>

<!--more-->


<h2>The setup</h2>

<p>Let‚Äôs start by <em>setting the stage</em>, for this particular project I was working with the following stack:</p>

<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-06-23/Stack.png" width="720" title="‚ÄôSpring + Data + Kotlin + Oracle‚Äô" ></p>

<h2>The problem</h2>

<p>So I had modeled the following <strong>Entity</strong> leveraging Kotlin‚Äôs <a href="https://kotlinlang.org/docs/reference/data-classes.html">data classes</a><sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>:</p>

<xmp class="kotlin-code" data-highlight-only>
import javax.persistence.Entity
import javax.persistence.Id

//sampleStart
@Entity
data class Person(
    val name: String,
    @Id val id: Long? = null
)
//sampleEnd
</xmp>


<p>Tests where passing with flying colors, but for some reason we were noticing that <strong>the <em>name</em> would sometimes come back as <code>null</code></strong> even thought it was typed as <code>String</code> and not <code>String?</code>.</p>

<h2>The analysis</h2>

<p>To make things more difficult there where other failures in the communication layer masking the real issue. But we finally figured out what was happening when we notice <strong>it was only reproducible under the following conditions</strong>:</p>

<ul>
<li>The property <code>name</code> was empty</li>
<li>Not reproducible on tests</li>
<li>Persisting to <em>OracleDB</em> (instead of embedded H2)</li>
</ul>


<p>That‚Äôs when I discovered:</p>

<blockquote><p>This is because Oracle internally changes empty string to NULL values. Oracle simply won't let insert an empty string.</p><footer><strong>Some guy on Stack Overflow</strong> <cite><a href='https://stackoverflow.com/a/13278879/1499171'>stackoverflow.com/a/13278879/&hellip;</a></cite></footer></blockquote>


<p>So when the data was mapped back to my <code>Person</code> object I ended up with a <code>null</code> value for <em>name</em>. This is probably only possible because <strong>Hibernate is using reflection to set the field value</strong> in runtime, thus breaking Kotlin‚Äôs <a href="https://kotlinlang.org/docs/reference/null-safety.html">null safety</a>.</p>

<h2>What I did about it</h2>

<p>The funny thing about this one is that <strong>there is not much you can do about it</strong>. <em>There is no magic configuration to tell Oracle how you want to handle empty strings.</em> Yes there are some hacks like changing <code>""</code> to <code>" "</code> but I‚Äôd rather invent a random <em>name</em> for the guy than persisting a whitespace.</p>

<p>The silver lining is that most of the time <strong>if you‚Äôre not allowing null values you probably don‚Äôt want an empty string either</strong>. Now YMMV but I know this was true for a person‚Äôs name.</p>

<p>In fact you might even want to <strong>implement a more strict validation</strong> so people can‚Äôt be named: ‚Äúüí©‚Äù.</p>

<h3>Testing</h3>

<p>First thing I did was to try to reproduce this using a test. But since I was using <code>@DataJpaTest</code> with H2 embedded DB empty strings where empty strings an nulls where nulls. So the issue was <strong>not reproducible</strong>.</p>

<p>That‚Äôs when I learned that you <strong>can tell H2 to behave like an Oracle DB</strong> using <a href="http://www.h2database.com/html/features.html">Oracle Compatibility mode</a>. To achieve this I added the following configuration to my <code>application.yml</code> under <code>test/resources</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>spring:
</span><span class='line'>  datasource:
</span><span class='line'>    url: jdbc:h2:mem:testdb;Mode=Oracle</span></code></pre></td></tr></table></div></figure>


<p>And annotated my test class with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="nl">SpringRunner:</span><span class="o">:</span><span class="n">class</span><span class="o">)</span>
</span><span class='line'><span class="nd">@DataJpaTest</span>
</span><span class='line'><span class="nd">@AutoConfigureTestDatabase</span><span class="o">(</span><span class="n">replace</span> <span class="o">=</span> <span class="n">AutoConfigureTestDatabase</span><span class="o">.</span><span class="na">Replace</span><span class="o">.</span><span class="na">NONE</span><span class="o">)</span>
</span><span class='line'><span class="kd">class</span> <span class="nc">FormRepositoryTest</span> <span class="o">{</span><span class="err">‚Ä¶</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And <em>voil√†</em>, now you have an <strong>H2 in memory DB dressed up as Oracle</strong>.</p>

<h3>Changing the schema</h3>

<p>The other thing I realized is that <strong>the schema allowed for <code>null</code> values</strong> on the <em>name</em> column. I‚Äôd been using <code>javax.persistence.schema-generation</code> as a starting point for my schema and <strong>I wrongly assumed</strong> it would take the hint from the Kotlin type system to prevent null values<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>.</p>

<p>Instead I had to explicitly annotate my Entity:</p>

<xmp class="kotlin-code" data-highlight-only>
import javax.persistence.Entity
import javax.persistence.Id

//sampleStart
@Entity
data class Person(
    @Column(nullable = false) val name: String,
    @Id val id: Long? = null
)
//sampleEnd
</xmp>


<p>and manually change my existing schema</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="nf">Person</span> <span class="o">(</span>
</span><span class='line'>  <span class="n">id</span> <span class="nf">NUMBER</span><span class="o">(</span><span class="mi">19</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="o">,</span>
</span><span class='line'>  <span class="n">name</span> <span class="nf">VARCHAR2</span><span class="o">(</span><span class="mi">255</span> <span class="n">CHAR</span><span class="o">)</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="o">,</span>
</span><span class='line'>  <span class="n">PRIMARY</span> <span class="nf">KEY</span> <span class="o">(</span><span class="n">id</span><span class="o">)</span>
</span><span class='line'><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result is that now if somebody tries to persist a Person with an empty name a <strong>big fat Exception is thrown</strong>. Or at least until I implement proper name validation.</p>

<script src="https://unpkg.com/kotlin-playground@1" data-selector=".kotlin-code"></script>



<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>If I had a dollar for every time I modeled a Person‚Ä¶<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>It would be nice right?<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[IntelliJ IDEA Tips]]></title>
    <link href="http://jivimberg.github.io/blog/2018/06/10/intellij-idea-tips/"/>
    <updated>2018-06-10T17:11:52-07:00</updated>
    <id>http://jivimberg.github.io/blog/2018/06/10/intellij-idea-tips</id>
    <content type="html"><![CDATA[<p>Here are a couple of <strong>IntelliJ IDEA</strong> shortcuts and configurations I wish I‚Äôd known sooner.</p>

<!--more-->


<h2>1. Changing the default font</h2>

<p>The <strong>first</strong> thing I do every time I have to configure a new installation of IntelliJ is setting the theme to <em>Darcula</em>.</p>

<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-06-10/Darcula.png" width="720" title="‚ÄôDarcula theme‚Äô" ></p>

<p>The <strong>second</strong> thing I do is <strong>changing the font</strong> to <a href="https://github.com/tonsky/FiraCode">Fira Code</a>, and <strong>enabling font ligatures.</strong> Here‚Äôs how it looks like:</p>

<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-06-10/FiraCodeExample.png" width="720" title="‚ÄôFira code example‚Äô" ></p>

<p>You can enable this from <code>Settings</code> > <code>Editor</code> > <code>Font</code>. Make sure to check <code>Enable font ligatures</code> if you like that <code>‚â†</code> symbol.</p>

<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-06-10/FiraCode.png" width="720" title="‚ÄôFira code setting‚Äô" ></p>

<h2>2. Auto-reformat</h2>

<p>If you‚Äôre one of those developers that is obsessively hitting <code>‚å•‚áß‚åòL</code>  to get your code reformatted on every keystroke then <strong>I‚Äôm about to change your life</strong>.</p>

<p>First install the <strong><a href="https://plugins.jetbrains.com/plugin/7642-save-actions">Save actions</a></strong> plugin. Now open <code>Settings</code> > <code>Other settings</code> > <code>Save actions</code>, in there select:</p>

<ul>
<li><code>Activate save actions on save</code></li>
<li><code>Reformat file</code></li>
<li>And customize any other inspection and quick fix to your liking</li>
</ul>


<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-06-10/saveActions.png" width="720" title="‚ÄôSave actions settings‚Äô" ></p>

<p>Now your can just spit your <em>ugly</em> code and <strong>it‚Äôll get perfectly formatted on each save</strong>. <em>Nice uh?</em></p>

<h2>3. Extend selection</h2>

<p>This is not a configuration, but one of my <strong>favorite shortcuts</strong>. I learned this from a <a href="https://youtu.be/bFcaO1pXzws?t=20m13s">talk</a> by <a href="https://twitter.com/hhariri?ref_src=twsrc%5Egoogle%7Ctwcamp%5Eserp%7Ctwgr%5Eauthor">Hadi Hariri</a>.</p>

<p>What is it for? Paraphrasing the <a href="https://blog.jetbrains.com/idea/2013/05/30-days-with-intellij-idea-editor-basics/">IntelliJ blog</a>:</p>

<blockquote><p>Structural selection allows you to select expressions based on grammar. By pressing <code>‚å•‚Üë</code> you keep expanding your selection (starting from the caret). And vice versa, you can shrink it by pressing <code>‚å•‚Üì</code>.<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p></blockquote>

<p>Here you can see it in action:</p>

<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-06-10/expandSelection.gif" title="‚ÄôExpand and shrink selection animation‚Äô" ></p>

<p>Just mentioning this one because it was new to me at the time and nowadays I find myself using it <strong>all the time!</strong></p>

<h2>Have any IntelliJ tip to share? I‚Äôd love to know about it! <strong>Post a comment</strong> down here üëá</h2>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Had to update the key mappings in the quote because they were old in the original blog post.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Implementing takeWhileInclusive in Kotlin]]></title>
    <link href="http://jivimberg.github.io/blog/2018/06/02/implementing-takewhileinclusive-in-kotlin/"/>
    <updated>2018-06-02T13:33:38-07:00</updated>
    <id>http://jivimberg.github.io/blog/2018/06/02/implementing-takewhileinclusive-in-kotlin</id>
    <content type="html"><![CDATA[<p>Implementing <code>takeWhileInclusive</code> extension function in Kotlin.</p>

<!--more-->


<blockquote><p>TL,DR (aka <em>‚Äújust show me the code‚Äù</em> ): <a href="https://gist.github.com/jivimberg/ff5aad3f5c6315deb420fd508a145c61">https://gist.github.com/jivimberg/ff5aad3f5c6315deb420fd508a145c61</a></p></blockquote>

<p>You probably know about <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/take-while.html"><code>takeWhile</code></a> operation that <strong>returns a List containing the first elements satisfying the given predicate.</strong></p>

<xmp class="kotlin-code">
fun main(args: Array<String>) {
//sampleStart
    val someNumbers = listOf(1, 5, 3, 22, 4, 8, 14, 23, 49, 77, 2, 49)
    println(someNumbers.takeWhile { it % 7 != 0 })
//sampleEnd
}
</xmp>


<p>I was in need of an <strong>inclusive</strong> version of the <code>takeWhile</code>. In other words I needed a function that returned the first elements satisfying the given predicate, <strong>plus the first element that didn‚Äôt satisfy it</strong>.</p>

<p>So in the provided example <code>takeWhile</code> returns <code>[1, 5, 3, 22, 4, 8]</code> whereas <code>takeWhileInclusive</code> would return <code>[1, 5, 3, 22, 4, 8, 14]¬†</code> .</p>

<p>A quick search showed me I was not alone. <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/take-while.html"><em>matklad</em></a> already had a simple implementation working for <code>Sequence</code>:</p>

<div><script src='https://gist.github.com/54776705250e3b375618f59a8247a237.js'></script>
<noscript><pre><code>fun &lt;T&gt; Sequence&lt;T&gt;.takeWhileInclusive(pred: (T) -&gt; Boolean): Sequence&lt;T&gt; {
    var shouldContinue = true
    return takeWhile {
        val result = shouldContinue
        shouldContinue = pred(it)
        result
    }
}
</code></pre></noscript></div>


<p>Using <strong>extension functions</strong> we are able to add a new function to the standard library type <code>Sequence</code>. If this is your first encounter with an extension function I‚Äôd encourage you to read more about them <a href="https://kotlinlang.org/docs/reference/extensions.html#extension-functions">here</a> and then play with them <a href="https://try.kotlinlang.org/#/Kotlin%20Koans/Introduction/Extension%20functions/Task.kt">here</a>.</p>

<p>I found this implementation of <code>takeWhileInclusive</code> quite <strong>elegant</strong>. It uses the original <code>takeWhile</code> with the given predicated, but keeps a <code>shouldContinue</code> variable to delay the predicate evaluation by one step. In other words the evaluation of the predicate passed to <code>takeWhile</code> on element <em>i</em> will actually be the result of applying the predicate function on <em>i - 1</em>. Which if you think about it <em>is exactly what we need</em>. Let‚Äôs give it a try:</p>

<xmp class="kotlin-code">
fun <T> Sequence<T>.takeWhileInclusive(
        predicate: (T) -> Boolean
): Sequence<T> {
    var shouldContinue = true
    return takeWhile {
        val result = shouldContinue
        shouldContinue = predicate(it)
        result
    }
}

fun main(args: Array<String>) {
//sampleStart
   val someNumbers = listOf(1, 5, 3, 22, 4, 8, 14, 23, 49, 77, 2, 49).asSequence()
   println(someNumbers.takeWhileInclusive { it % 7 != 0 }.toList())
//sampleEnd
}
</xmp>


<p>This was good! Only <a href="https://gist.github.com/matklad/54776705250e3b375618f59a8247a237#gistcomment-2093675">this comment</a> posted on the original gist made me doubt about the <em>safety</em> of this approach:</p>

<blockquote><p><em>‚ÄúI love this. If Sequence were parallel, though, wouldn&rsquo;t there be worries about using out-of-closure state?‚Äù</em></p></blockquote>

<p>That send me down the rabbit hole and I spent some days reading about <code>parallelStreams</code> and <code>coroutines</code> until I convinced my self the approach was ok.<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>

<p>With that out of the way I decided to port this solution to be supported in all the places where the <code>takeWhile</code> exists (including <code>String</code> and <code>CharArray</code>). So that <strong>we don‚Äôt have to convert to a from a Sequence just to use this function</strong>.</p>

<p>Here‚Äôs the end result, ready to be dropped on your project:</p>

<div><script src='https://gist.github.com/ff5aad3f5c6315deb420fd508a145c61.js'></script>
<noscript><pre><code>// kotlin.collections

inline fun &lt;T&gt; Array&lt;out T&gt;.takeWhileInclusive(
        predicate: (T) -&gt; Boolean
): List&lt;T&gt; {
    var shouldContinue = true
    return takeWhile {
        val result = shouldContinue
        shouldContinue = predicate(it)
        result
    }
}

inline fun ByteArray.takeWhileInclusive(
        predicate: (Byte) -&gt; Boolean
): List&lt;Byte&gt; {
    var shouldContinue = true
    return takeWhile {
        val result = shouldContinue
        shouldContinue = predicate(it)
        result
    }
}

inline fun ShortArray.takeWhileInclusive(
        predicate: (Short) -&gt; Boolean
): List&lt;Short&gt; {
    var shouldContinue = true
    return takeWhile {
        val result = shouldContinue
        shouldContinue = predicate(it)
        result
    }
}

inline fun IntArray.takeWhileInclusive(
        predicate: (Int) -&gt; Boolean
): List&lt;Int&gt; {
    var shouldContinue = true
    return takeWhile {
        val result = shouldContinue
        shouldContinue = predicate(it)
        result
    }
}

inline fun LongArray.takeWhileInclusive(
        predicate: (Long) -&gt; Boolean
): List&lt;Long&gt; {
    var shouldContinue = true
    return takeWhile {
        val result = shouldContinue
        shouldContinue = predicate(it)
        result
    }
}

inline fun FloatArray.takeWhileInclusive(
        predicate: (Float) -&gt; Boolean
): List&lt;Float&gt; {
    var shouldContinue = true
    return takeWhile {
        val result = shouldContinue
        shouldContinue = predicate(it)
        result
    }
}

inline fun DoubleArray.takeWhileInclusive(
        predicate: (Double) -&gt; Boolean
): List&lt;Double&gt; {
    var shouldContinue = true
    return takeWhile {
        val result = shouldContinue
        shouldContinue = predicate(it)
        result
    }
}

inline fun BooleanArray.takeWhileInclusive(
        predicate: (Boolean) -&gt; Boolean
): List&lt;Boolean&gt; {
    var shouldContinue = true
    return takeWhile {
        val result = shouldContinue
        shouldContinue = predicate(it)
        result
    }
}

inline fun CharArray.takeWhileInclusive(
        predicate: (Char) -&gt; Boolean
): List&lt;Char&gt; {
    var shouldContinue = true
    return takeWhile {
        val result = shouldContinue
        shouldContinue = predicate(it)
        result
    }
}

inline fun &lt;T&gt; Iterable&lt;T&gt;.takeWhileInclusive(
        predicate: (T) -&gt; Boolean
): List&lt;T&gt; {
    var shouldContinue = true
    return takeWhile {
        val result = shouldContinue
        shouldContinue = predicate(it)
        result
    }
}

// kotlin.sequences

fun &lt;T&gt; Sequence&lt;T&gt;.takeWhileInclusive(
        predicate: (T) -&gt; Boolean
): Sequence&lt;T&gt; {
    var shouldContinue = true
    return takeWhile {
        val result = shouldContinue
        shouldContinue = predicate(it)
        result
    }
}

// kotlin.text

inline fun CharSequence.takeWhileInclusive(
        predicate: (Char) -&gt; Boolean
): CharSequence {
    var shouldContinue = true
    return takeWhile {
        val result = shouldContinue
        shouldContinue = predicate(it)
        result
    }
}

inline fun String.takeWhileInclusive(
        predicate: (Char) -&gt; Boolean
): String {
    var shouldContinue = true
    return takeWhile {
        val result = shouldContinue
        shouldContinue = predicate(it)
        result
    }
}</code></pre></noscript></div>


<p>Hope you find this useful!</p>

<script src="https://unpkg.com/kotlin-playground@1" data-selector=".kotlin-code"></script>



<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>If you want to read more about my discoveries, check this question at <a href="https://stackoverflow.com/q/50373754/1499171">StackOverflow</a><a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Book Recomendations: Migrating to Microservices Databases]]></title>
    <link href="http://jivimberg.github.io/blog/2018/05/25/book-recomendations-migrating-to-microservices-databases/"/>
    <updated>2018-05-25T07:32:00-07:00</updated>
    <id>http://jivimberg.github.io/blog/2018/05/25/book-recomendations-migrating-to-microservices-databases</id>
    <content type="html"><![CDATA[<p>Just finished reading <em>¬†Migrating to microservices databases</em> by <a href="https://twitter.com/yanaga">Edson Yanaga</a>. If you can relate to the 3 nouns in the title then you‚Äôll want to check it out.</p>

<!--more-->


<blockquote><p>Code is easy; state is hard.</p>

<p>‚Äî <em>Edson Yanaga</em></p></blockquote>

<p>If you are on the journey of <strong>migrating your monolith to a micro-service architecture</strong> (like every other developer this days) then, at some point, you probably found yourself staring at a whiteboard full of rectangles and hexagons thinking: <em>where does the data fit in this mess?</em></p>

<p>Maybe you‚Äôve read about the <a href="http://microservices.io/patterns/data/database-per-service.html">‚ÄúDatabase per service‚Äù</a> pattern and now you‚Äôre wondering what your requirements are on <a href="https://en.wikipedia.org/wiki/Consistency_(database_systems)">data consistency</a>. Or somebody told you about <a href="https://martinfowler.com/bliki/CQRS.html">CQRS</a> but you don‚Äôt know it‚Äôs advantages and disadvantages.</p>

<p><a href="https://developers.redhat.com/promotions/migrating-to-microservice-databases/"><img class="center" src="http://jivimberg.github.io/images/posts/2018-05-26/MigratingToMicroservicesDatabases.png" title="‚ÄôMigrating to Micro-services databases book cover‚Äô" ></a></p>

<p>Edson‚Äôs book opens with a brief recap of the micro-service world. Going from <em>‚ÄúWhy microservices‚Äù</em> to <a href="https://en.wikipedia.org/wiki/A/B_testing">A/B testing</a> and <a href="https://martinfowler.com/bliki/CanaryRelease.html">Canary deployment</a>, the book provides a <strong>super-quick explanation of each concept without going into many details.</strong></p>

<p>By contrast the second part of the book deeps dive into <strong>how to handle the data</strong> of your micro-services. <em>Chapter 3</em> explains how to do <strong>Zero downtime migration</strong> of your relational DB and which tools to use.</p>

<p>On <em>Chapter 4</em> Edson introduces the different <strong>consistency models</strong> and compares <strong>CRUD Vs. CQRS</strong> (explaining also <em>Event sourcing</em>)</p>

<p><strong>The last chapter is, to me, the best.</strong> <em>Chapter 5</em>  contains a recount and description of some of the different <strong>Integration Strategies</strong> we might want to consider when <em>migrating the monolith</em>. Each strategy is briefly described, and we are also provided with an assessment of <strong>applicability</strong> and section of <strong>considerations</strong> to keep in mind if using this strategy.</p>

<h2>Conclusion</h2>

<p>The hardest part of design is not knowing the architectural patterns or the different techniques to solve a problem, but <strong>knowing which solution is a good fit to which problem.</strong> Yanaga‚Äôs book serves as a good <strong>catalog of possible solutions</strong> to consider, when working with data on micro-services. It provides a concise analysis of each <strong>strategy</strong> and helps us avoid those  <em>‚ÄùI wish I‚Äôve thought this better before writing the code‚Äù</em> moments.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Spring Functional Routing]]></title>
    <link href="http://jivimberg.github.io/blog/2018/05/20/spring-functional-router/"/>
    <updated>2018-05-20T00:16:22-07:00</updated>
    <id>http://jivimberg.github.io/blog/2018/05/20/spring-functional-router</id>
    <content type="html"><![CDATA[<p>This post is about the clever tricks you can pull with Spring new <strong>functional routing</strong> and it‚Äôs Kotlin DSL.</p>

<!--more-->


<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-05-19/trainSwitch.jpg" title="‚ÄôTrain switch‚Äô" ></p>

<p>Spring 5 introduced the <a href="https://spring.io/blog/2016/09/22/new-in-spring-5-functional-web-framework">Functional Web Framework</a> and with it the ability to do functional routing. Basically instead of annotating your methods with the good old <code>@RequestMapping</code> you can now write functions that go from a <code>Request</code> to a <code>Response&lt;T&gt;</code> (called <code>HandlerFunction&lt;T&gt;</code>). And then use a <code>RouterFunction&lt;T&gt;</code> to map which path will end up in which handler.</p>

<p>Now, for the sake of brevity, I won‚Äôt talk about all the benefits of this new functional paradigm. Instead I‚Äôd like to focus on <strong>some things that can be done with functional routing that were not possible before</strong>.</p>

<p>I have to admit that <strong>at first</strong> I wasn‚Äôt sold on the functional routing thing. Why would I want to replace <code>@RequestMapping</code> with 2 different functions? Isn‚Äôt that more code to achieve the same goal? For comparison this is how a <em>simple</em> RoutingFunction could look like<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>:</p>

<xmp class="kotlin-code" data-highlight-only>
    fun router() = router {
        accept(TEXT_HTML).nest {
            GET("/") { permanentRedirect(URI("index.html")).build() }
        }
        "/api".nest {
            accept(APPLICATION_JSON).nest {
                GET("/users", userHandler::findAll)
                POST("/users", userHandler::create)
            }
        }
        resources("/**", ClassPathResource("static/"))
    } 
</xmp>


<p>It‚Äôs readable but certainly not as succinct as <code>@GetMapping("/api/users")</code>. But <strong>this terseness comes at the price of expressiveness</strong>. Or as <a href="https://spring.io/blog/2016/09/22/new-in-spring-5-functional-web-framework">this article on Spring.io</a> puts it:</p>

<blockquote><p>The <code>RouterFunction</code> has a similar purpose as a <code>@RequestMapping</code> annotation. However, there is an important distinction: with the annotation <strong>your route is limited to what can be expressed through the annotation values</strong>.</p></blockquote>

<h2>Complex routing</h2>

<p>I‚Äôll use an example to illustrate some of the things that can be achieved with complex routing. Say I have some data modeling a <em>r√©sum√©</em> that contains multiple <em>sections</em>. <strong>I want to expose each of this sections as a different REST endpoint</strong>. Underneath we need to handle each call the same way, the only difference is that we‚Äôd be processing a different <em>section</em> of data. We could do the routing like this:</p>

<xmp class="kotlin-code" data-highlight-only>
import org.springframework.context.annotation.Bean
import org.springframework.context.annotation.Configuration
import org.springframework.core.io.ClassPathResource
import org.springframework.http.MediaType
import org.springframework.web.reactive.function.server.RouterFunctions.resources
import org.springframework.web.reactive.function.server.router

//sampleStart
    enum class Section(val fieldName: String) {
    PERSONAL_INFO("personalInfo"),
    EXPERIENCE("experience"),
    SIDE_PROJECTS("sideProject"),
    EDUCATION("education"),
}

@Configuration
class Routing {
    @Bean
    fun resumeRouter(handler: ResumeHandler) = router {
        accept(MediaType.APPLICATION_JSON).nest {
            Section.values().forEach {
                GET("/${it.fieldName}", handler.getSectionHandler(it))
            }
        }
    }
}
//sampleEnd

@Component
class ResumeHandler {
fun getSectionHandler(section: Section): (ServerRequest) -\> Mono<ServerResponse> =
            { // get section from data and return response }
}
</xmp>


<p>We can iterate through the enum and create a new mapping for each of the sections with the <code>GET</code> function. Furthermore the function <code>getSectionHandler</code> can receive the enum as parameter and use it for handling the response instead of having to rely only on the <code>ServerRequest</code> context.</p>

<p>Now this is only one of the <em>tricks</em> that can be done with functional routing. Having a <a href="https://spring.io/blog/2017/08/01/spring-framework-5-kotlin-apis-the-functional-way#functional-routing-with-the-kotlin-dsl-for-spring-webflux">Kotlin DSL</a> means we can do <strong>any kind of scripting we can think of</strong> when defining the routes. As always:</p>

<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-05-19/withGreatPower.png" title="‚ÄôWith great power comes great responsibility‚Äô" ></p>

<p>Abusing this feature would make your routing logic a <strong>tangled mess</strong>, too hard to understand and maintain. So be smart about it.</p>

<script src="https://unpkg.com/kotlin-playground@1" data-selector=".kotlin-code"></script>



<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Source: [kotlin-swagger-spring-functional-template][2]<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Parallel Map in Java (From Kotlin)]]></title>
    <link href="http://jivimberg.github.io/blog/2018/05/07/parallel-map-in-java/"/>
    <updated>2018-05-07T13:19:58-07:00</updated>
    <id>http://jivimberg.github.io/blog/2018/05/07/parallel-map-in-java</id>
    <content type="html"><![CDATA[<p>Following up of my <a href="http://jivimberg.io/blog/2018/05/04/parallel-map-in-kotlin/">previous post</a>, I was curious how a parallel map operation would look like using Java‚Äôs <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#parallelStream--"><code>parallelStream</code></a>. Here‚Äôs what I find out.</p>

<!--more-->


<p>In Java to use <code>map</code> you do:</p>

<xmp class="kotlin-code">
import java.util.stream.Collectors

//sampleStart
fun main(args: Array<String>) {
    val output = (1..100).toList()
            .stream()
            .map { it * 2 }
            .collect(Collectors.toList())
    println(output)
}
//sampleEnd
</xmp>


<p><em>(In case you‚Äôre wondering I‚Äôm using Java collections from Kotlin)</em></p>

<p>And to do a <em>parallel</em> <code>map</code> you can simply do:</p>

<xmp class="kotlin-code">
import java.util.stream.Collectors

//sampleStart
fun main(args: Array<String>) {
    val output = (1..100).toList()
            .parallelStream()
            .map { it * 2 }
            .collect(Collectors.toList())
    println(output)
}
//sampleEnd
</xmp>


<p>No need to write a special <code>pmap</code> operation like we did for Kotlin. Just call <code>parallelStream</code> and that‚Äôs it. <em>Pretty cool, right?</em></p>

<p>I was curious about how this solution <strong>compared to the one on <a href="http://jivimberg.io/blog/2018/05/04/parallel-map-in-kotlin/">my previous post</a></strong>,  so I decided to time it too.</p>

<xmp class="kotlin-code">
import java.util.stream.Collectors
import kotlin.system.measureTimeMillis

//sampleStart
fun main(args: Array<String>) {
    val time = measureTimeMillis {
        val output = (1..100).toList()
                .parallelStream()
                .map {
                    Thread.sleep(100)
                    it * 2
                }
                .collect(Collectors.toList())

        println(output)
    }

    println("Total time: $time")
}
//sampleEnd
</xmp>


<p>In this case instead I‚Äôm actually setting a delay of <strong>100 milliseconds</strong> (instead of <em>1,000</em> like I did on my previous post)<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>. I was expecting the total time to be something close to <em>100 milliseconds</em>, just like it was for the Kotlin <code>pmap</code>, <strong>instead I got something close to 5,000</strong>.</p>

<p>Turns out <code>parallelStream</code> uses the default <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ForkJoinPool.html"><em>ForkJoinPool.commonPool</em></a> which by default has a parallelism level <strong>equal to the number of available processors.</strong> In this case 2 processors: <em>100 operations * 100 milliseconds / 2 processors = 5000 milliseconds</em>. You can check the number of available processors simply by adding this line to the script:</p>

<p><code>println(Runtime.getRuntime().availableProcessors())</code></p>

<h2>But, I want more parallelism!</h2>

<p>What if we want to increase the parallelism level? There are <em>2 ways to achieve this.</em></p>

<p><em>The first one</em> is to make our code <strong>run in a custom thread pool</strong> of our choice. Unfortunately Java doesn‚Äôt make it easy to provide a custom thread pool, but <a href="http://www.baeldung.com/java-8-parallel-streams-custom-threadpool">the workaround is not so bad either</a>.</p>

<p><em>The other option</em> is to change the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ForkJoinPool.html"><em>ForkJoinPool.commonPool</em></a> parallelism level by system property like this:</p>

<p><code>System.setProperty("java.util.concurrent.ForkJoinPool.common.parallelism", "10")</code></p>

<p>Unfortunately this doesn‚Äôt work on Kotlin Playground so you‚Äôll have to try it on your own machine or take my word that it works.</p>

<p>It‚Äôs worth noting that with the second approach you‚Äôd still be using the same default thread pool <strong>shared globally across the app</strong>. As you can imagine this can be <strong>EXTREMELY BAD</strong> as you‚Äôd be basically depleting resources for the whole application. Some would even argue <a href="https://zeroturnaround.com/rebellabs/java-parallel-streams-are-bad-for-your-health/">this is reason enough not to use <code>parallelStream</code> at all</a>. Although that seems a little extreme if you ask me.</p>

<script src="https://unpkg.com/kotlin-playground@1" data-selector=".kotlin-code"></script>



<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Otherwise the execution takes too long and doesn‚Äôt complete. Probably a limitation of Kotlin Playground<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Parallel Map in Kotlin]]></title>
    <link href="http://jivimberg.github.io/blog/2018/05/04/parallel-map-in-kotlin/"/>
    <updated>2018-05-04T16:32:00-07:00</updated>
    <id>http://jivimberg.github.io/blog/2018/05/04/parallel-map-in-kotlin</id>
    <content type="html"><![CDATA[<p>Ever wonder how to run <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/map.html"><code>map</code></a>  in parallel using coroutines? This is how you do it.</p>

<!--more-->




<xmp class="kotlin-code" data-highlight-only>
import kotlinx.coroutines.experimental.async
import kotlinx.coroutines.experimental.runBlocking

//sampleStart
fun <A, B>Iterable<A>.pmap(f: suspend (A) -> B): List<B> = runBlocking {
    map { async { f(it) } }.map { it.await() }
}
//sampleEnd
</xmp>


<p><em>Confused?</em> Let‚Äôs unpack it.</p>

<p>First we have the <strong>function signature</strong> which is pretty similar to the actual <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/map.html"><code>map</code></a> extension function signature on <code>Iterable</code>. The only thing we added was the <code>suspend</code> keyword on the parameter, which let‚Äôs us use <code>suspend</code> functions in <code>f</code> (as we‚Äôre going to see in a moment).</p>

<p>Then we have the <code>runBlocking</code> which let‚Äôs us bridge the blocking code with the coroutine world. As the name suggests <strong>this will block the current thread until everything inside the block finishes executing</strong>. Which is exactly what we want.</p>

<p>Finally we have the actual execution which is divided in 2 steps. The <em>first step</em> <strong>launches a new coroutine for each function application</strong> using <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.experimental/async.html"><code>async</code></a>. This effectively wraps the type of each element with  <code>Deferred</code>. In the <em>second step</em> we wait for all function applications to complete and unwrap the result with <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.experimental/-deferred/await.html"><code>await</code></a>.<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>

<h2>How to use it</h2>

<p>Easy! <strong>Just like you use <code>map</code></strong>:</p>

<xmp class="kotlin-code">
import kotlinx.coroutines.experimental.async
import kotlinx.coroutines.experimental.runBlocking

fun <A, B>Iterable<A>.pmap(f: suspend (A) -> B): List<B> = runBlocking {
    map { async { f(it) } }.map { it.await() }
}
//sampleStart
fun main(args: Array<String>) {
    println((1..100).pmap { it * 2 })
}
//sampleEnd
</xmp>


<p>(Psst! I‚Äôm using <a href="https://blog.jetbrains.com/kotlin/2018/04/embedding-kotlin-playground/">Kotlin Playground</a> so you can actually run this code!)</p>

<h2>Prove that it‚Äôs running in parallel</h2>

<p>Ok so let‚Äôs resort to the good old <code>delay</code> to prove that this is actually running in parallel. We are going to add a <strong>delay of 1 second</strong> on each multiplication and measure the time it takes to run.</p>

<p>Running over <em>100 elements</em> the result should be: <strong>close to 1,000 milliseconds if it‚Äôs running in parallel</strong> and close to <em>100,000 milliseconds if it‚Äôs running sequentially</em>.</p>

<xmp class="kotlin-code">
import kotlinx.coroutines.experimental.async
import kotlinx.coroutines.experimental.runBlocking
import kotlin.system.measureTimeMillis
import kotlinx.coroutines.experimental.delay

fun <A, B>Iterable<A>.pmap(f: suspend (A) -> B): List<B> = runBlocking {
    map { async { f(it) } }.map { it.await() }
}
//sampleStart
fun main(args: Array<String>) {
    val time = measureTimeMillis {
        val output = (1..100).pmap {
            delay(1000)
            it * 2
        }

        println(output)
    }

    println("Total time: $time")
}
//sampleEnd
</xmp>




<script src="https://unpkg.com/kotlin-playground@1" data-selector=".kotlin-code"></script>



<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Since I‚Äôm not explicitly passing any  <code>CoroutineContext</code> the <code>DefaultDispatcher</code> will be used. <a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Book Recommendations: Isomorphic JavaScript Web Development]]></title>
    <link href="http://jivimberg.github.io/blog/2018/04/30/book-recommendations-isomorphic-javascript-web-development/"/>
    <updated>2018-04-30T07:15:04-07:00</updated>
    <id>http://jivimberg.github.io/blog/2018/04/30/book-recommendations-isomorphic-javascript-web-development</id>
    <content type="html"><![CDATA[<p>I finally got around to finish the new book my friend and colleague <a href="http://tomasalabes.me/">@talabes</a> wrote and I think it‚Äôs great. Here‚Äôs why.</p>

<!--more-->


<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-04-30/ketchup2.png" width="250" title="‚ÄôMr Burns ketchup catsup‚Äô" ></p>

<p>‚òùThat‚Äôs me every single time I try to start a <em>simple</em> web project. If you are like me, not a full-time front-end developer, you probably know what I‚Äôm talking about (if not check <strong><a href="https://hackernoon.com/how-it-feels-to-learn-javascript-in-2016-d3a717dd577f">this article</a></strong> and try not to choke on your cereal laughing).</p>

<p>I found <a href="https://read.amazon.com/kp/embed?asin=B01DWFRFVG&amp;preview=newtab&amp;linkCode=kpe&amp;ref_=cm_sw_r_kb_dp_atY5Ab9H5Y5ZH">Tomas‚Äô book</a> to be the perfect cure against <a href="https://xkcd.com/1801/">decision paralysis</a> in the world of JavaScript web development. His approach is practical and concise:</p>

<blockquote><p><em>‚ÄúHere‚Äôs the <strong>stack</strong> we are using. This is how you <strong>set it up</strong> and this is a <strong>basic example</strong> of what we‚Äôre trying to achieve. If you want to go deeper go and read this.‚Äù<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></em></p></blockquote>

<p>From <strong>testing</strong> and <strong>bundling</strong> to <strong>routing</strong> and <strong>security</strong> this book goes through all the topics a developer needs to know, with easy-to-follow examples and useful tips <em>‚Äùfrom-the trenches‚Äù</em>. It serves as a <strong>comprehensive guide</strong>, covering all the things we need to consider to get our application up and running.</p>

<p>Finally, I love that the book answers <strong>common questions</strong> that sometimes other introductory material gloss over. Things like: <em>‚Äùhow do I structure my project?‚Äù</em> or <em>‚Äùhow can I troubleshoot and debug this thing?‚Äù</em>.</p>

<p>Curious? Take a quick look:</p>

<iframe type="text/html" width="336" height="550" frameborder="0" allowfullscreen style="margin: auto; display: block; max-width:100%" src="https://read.amazon.com/kp/card?asin=B01DWFRFVG&preview=inline&linkCode=kpe&ref_=cm_sw_r_kb_dp_atY5Ab9H5Y5ZH" ></iframe>



<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>I‚Äôm not actually quoting Tomas, of course<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Jacoco & Gradle - How to Verify Coverage With Exclusions]]></title>
    <link href="http://jivimberg.github.io/blog/2018/04/26/gradle-verify-coverage-with-exclusions/"/>
    <updated>2018-04-26T08:49:52-07:00</updated>
    <id>http://jivimberg.github.io/blog/2018/04/26/gradle-verify-coverage-with-exclusions</id>
    <content type="html"><![CDATA[<p>A post about how to add exclusions to your Jacoco test coverage verification in Gradle.</p>

<!--more-->


<p>This is how you setup Jacoco to fail when the code doesn‚Äôt meet the expected coverage threshold:</p>

<div><script src='https://gist.github.com/ea79614ce9b80c29b03be8326586f238.js'></script>
<noscript><pre><code>apply plugin: &quot;jacoco‚Äù

jacocoTestCoverageVerification {
    violationRules {
        rule {
            limit {
                minimum = 0.79
            }
        }
    }
}


// to run coverage verification during the build (and fail when appropriate)
check.dependsOn jacocoTestCoverageVerification  </code></pre></noscript></div>


<p>See that <code>rule</code>?  I‚Äôm not setting any particular <code>element</code> so <a href="https://docs.gradle.org/current/javadoc/org/gradle/testing/jacoco/tasks/rules/JacocoViolationRule.html#getElement--">by default it‚Äôll set <em>BUNDLE</em></a>. <strong>This is just what I want as I‚Äôd like to set a threshold for the coverage of the entire module.</strong></p>

<p>So if I need to exclude certain <strong>packages</strong> or <strong>files</strong> from the count this is what I do:</p>

<div><script src='https://gist.github.com/3ee0beaa9ab8b20b48e4273378dcd30e.js'></script>
<noscript><pre><code>jacocoTestCoverageVerification {
    afterEvaluate {
        classDirectories = files(classDirectories.files.collect {
            fileTree(dir: it, exclude:  [
                    &#39;com/example/my/package/*&#39;,
                    &#39;com/example/service/MyApplication.kt&#39;,
                    &#39;com/google/protobuf/*&#39;
            ])
        })
    }

    violationRules {
        rule {
            limit {
                minimum = 0.79
            }
        }
    }
}</code></pre></noscript></div>


<h3>Why <em>exclude</em> doesn‚Äôt work</h3>

<p>My first approach was setting the <code>excludes</code> property on the rule like this:</p>

<div><script src='https://gist.github.com/0962942885d4db41a9dad890aba5d225.js'></script>
<noscript><pre><code>jacocoTestCoverageVerification {
    violationRules {
        rule {
            excludes = [
                    &#39;com/example/my/package/*&#39;,
                    &#39;com/example/service/MyApplication.kt&#39;,
                    &#39;com/google/protobuf/*&#39;
            ]
            limit {
                minimum = 0.79
            }
        }
    }
}</code></pre></noscript></div>


<p>The reason this doesn‚Äôt work is that <code>excludes</code> works on objects of the type defined with the <code>element</code> property. In this case the type is <em>BUNDLE</em> whereas the thing we want to exclude are <strong>packages</strong> and <strong>files</strong>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Go Channels in Kotlin - an Example]]></title>
    <link href="http://jivimberg.github.io/blog/2018/04/23/go-channels-in-kotlin-an-example/"/>
    <updated>2018-04-23T08:37:13-07:00</updated>
    <id>http://jivimberg.github.io/blog/2018/04/23/go-channels-in-kotlin-an-example</id>
    <content type="html"><![CDATA[<p>This is the story of a real use case that was solved by using <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/coroutines-guide.md#channels">Go style channels in Kotlin</a>.</p>

<!--more-->


<h2>The use case</h2>

<p>At work we have this CI/CD pipeline to get our code into production, and we needed a way of visualizing the Merge Requests that currently in the pipeline.</p>

<p>To make this happen we have 2 things:</p>

<ul>
<li>The GitLab service, accessible through <a href="https://docs.gitlab.com/ee/api">REST</a></li>
<li>The commit SHA of the last Merge Request that went into production</li>
</ul>


<p><img class="center" src="http://jivimberg.github.io/images/posts/2018-04-24/useCase.png" title="‚ÄòUse Case‚Äô" ></p>

<p>Now the problem is that <a href="https://docs.gitlab.com/ee/api/merge_requests.html">Merge Request endpoint</a> doesn‚Äôt allow for this kind of query. You can only search Merge Requests by <em>title</em> or <em>description</em> which is not what we want. So our only option is to get the latest Merge Requests up until we see the one that is in production.</p>

<p>The REST endpoint is paginated, and by default each response will contain 20 items. But what happens if the Merge Request we are looking for is not in those first 20 elements? <strong>We‚Äôll need to keep making requests for new pages until we find the item we‚Äôre interested in</strong>. It‚Äôs not the most elegant solution but we‚Äôll have to make do with what we have.</p>

<h2>Our first approach: imperative</h2>

<p>Our first try of putting that last paragraph into code looked something like this:</p>

<div><script src='https://gist.github.com/862c4ee1c72603a224d57b30eedf74fc.js?file=ImperativeApproach.kt'></script>
<noscript><pre><code>fun fetchMergeRequests(gitLabService: GitLabService, lastProductionSha: String): List&lt;MergeRequest&gt; {
    var page = 1
    var mergeRequests = emptyList&lt;MergeRequest&gt;()
    
    // Fetch pages until we have the one that contains the commit we are looking for 
    while (mergeRequests.none { it.commitSha == lastProductionSha }) {
        mergeRequests += gitLabService.fetchMergeRequests(page++)
    }

    // Trim the Merge Requests that are already in production
    val indexOfLastMergeRequestInProduction = mergeRequests.indexOfLast { it.commitSha == lastProductionSha }
    return mergeRequests.subList(0, indexOfLastMergeRequestInProduction)
}</code></pre></noscript></div>


<p>Not pretty, but it does the job.</p>

<p>The next attempt we made was implementing it as an <code>Iterable</code>. And it was even uglier! Believe me, you don‚Äôt even want to see that one. Your retina might burn just from looking at the <a href="https://gist.github.com/jivimberg/862c4ee1c72603a224d57b30eedf74fc#file-iterableapproach-kt">code‚Ä¶</a></p>

<h2>Using <em>buildSequence</em></h2>

<p>We kept looking for a way of making the code cleaner, so we decide to try using <a href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.coroutines.experimental/build-sequence.html"><code>buildSequence</code></a>. It seemed like a good idea because a sequence can be thought as an <code>Iterator</code> where the values are evaluated lazily. So potentially <code>Sequences</code> can be infinite.</p>

<p>To make use of this feature we needed to add the <a href="https://mvnrepository.com/artifact/org.jetbrains.kotlinx/kotlinx-coroutines-core">kotlinx-coroutines-core</a>
 to our project. Anyway, this is how the code looked like:</p>

<div><script src='https://gist.github.com/862c4ee1c72603a224d57b30eedf74fc.js?file=SequenceApproach.kt'></script>
<noscript><pre><code>fun fetchMergeRequestsSequence(gitLabService: GitLabService, lastProductionSha: String): List&lt;MergeRequest&gt; {
    val mrSequence = buildSequence {
        var page = 1
        while (true) yieldAll(gitLabService.fetchMergeRequests(page++))
    }

    return mrSequence
            .takeWhile { it.commitSha != lastProductionSha }
            .toList()
}</code></pre></noscript></div>


<p>Let‚Äôs unpack it:</p>

<ol>
<li>First we have the sequence declaration. We call the build sequence function which receives a <em>lambda with receiver</em>: <code>SequenceBuilder&lt;T&gt;.() -&gt; Unit</code>. This allows us to call the methods <code>yield</code> and <code>yieldAll</code> once we have calculated the values to be produced on this sequence. We use <code>yieldAll</code> in this case because we receive a Collection of values from the REST call, otherwise the type of the sequence would be: <code>Sequence&lt;List&lt;MergeReques&gt;&gt;</code> whereas we only need <code>Sequence&lt;MergeRequest&gt;</code></li>
<li>We use <code>takeWhile { ... }</code> to only get the Merge Requests that are <strong>not</strong> in production.</li>
<li>We convert the sequence to a List and return</li>
</ol>


<p>You might be thinking <strong>‚ÄùOk but, why is this better than the imperative approach?‚Äù</strong></p>

<p>For starters this code is easier to read. This alone is reason enough in my book, as the quote goes:</p>

<blockquote><p><em>‚ÄùAny fool can write code that a computer can understand. <strong>Good programmers write code that humans can understand.</strong>‚Äù</em></p>

<p>Martin Fowler</p></blockquote>

<p>As a bonus by using a <code>Sequence</code> we get some extra flexibility. In the imperative approach the condition is right in the middle of the function. Using sequences we could easily have a function that generates the sequence and then write other functions that use it, leveraging all the awesome collection functions (<code>filter</code>, <code>find</code>, <code>take</code>, <code>drop</code>, etc).</p>

<p>It is important to note that when using sequences the evaluation is lazy (just like Java streams). In our case that means that <code>takeWhile</code> will only start once we call the <code>toList</code> function, because <code>toList</code> is a <em>terminal</em> operation.</p>

<p>So are we using coroutines now? <strong>YES!</strong> But‚Ä¶ <code>buildSequence</code> is coroutine builder that creates a <em>synchronous coroutine</em>. This means that even thought it uses coroutines everything is executed sequentially.</p>

<h2>Using channels</h2>

<p>Finally we decided to go all in on coroutines by using channels. This is the result:</p>

<div><script src='https://gist.github.com/862c4ee1c72603a224d57b30eedf74fc.js?file=ChannelApproach.kt'></script>
<noscript><pre><code>fun fetchMergeRequestsChannel(gitLabService: GitLabService, lastProductionSha: String): ReceiveChannel&lt;MergeRequest&gt; {
    return produce {
        var page = 1
        while (true) {
            gitLabService.delayedFetchMergeRequests(page++).forEach { send(it) }
        }
    }.takeWhile { it.commitSha != lastProductionSha }
}

fun main(args: Array&lt;String&gt;) {
    val mrs = fetchMergeRequestsChannel(GitLabService(), &quot;04d78f5c7cd51c52d0482d08224ff6a214da12c1&quot;)

    runBlocking {
        delay(10, TimeUnit.SECONDS)
        mrs.consumeEach {
            println(&quot;consuming $it&quot;)
        }
    }
}</code></pre></noscript></div>


<p>Now we have a function that creates a channel, and we are using <code>consumeEach</code>  to receive each of the elements the channel sends. Since <code>consumeEach</code> is a suspending function <strong>we have to call it from a coroutine context</strong>, <code>runBlocking</code> helps us bridge the gap between blocking execution and the coroutines world.</p>

<p>With <code>ReceiveChannel</code> we have the flexibility of <code>Sequences</code>, but we also get one more thing: <strong>concurrency!</strong>. You can see that I‚Äôve added an artificial <code>delay</code> call before beginning to consume the Merge Requests. This is to show that <strong>even before the receiver is ready to consume the channel, the producer has already started to fetch elements</strong>. In this case since we‚Äôre using an <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/coroutines-guide.md#buffered-channels"><em>unbuffered channel</em></a> only one send will be called before suspending the coroutine. But that‚Äôs all we need since in our case sending 1 element means that we‚Äôve already fetched the whole first page!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How I Stumbled With Knockout's Computed Observables]]></title>
    <link href="http://jivimberg.github.io/blog/2016/05/01/how-i-stumbled-with-knockouts-computed-observables/"/>
    <updated>2016-05-01T15:01:16-07:00</updated>
    <id>http://jivimberg.github.io/blog/2016/05/01/how-i-stumbled-with-knockouts-computed-observables</id>
    <content type="html"><![CDATA[<p>The first thing you learn about Knockout is about <a href="http://knockoutjs.com/documentation/observables.html">observables</a>. The second thing is <a href="http://knockoutjs.com/documentation/computedObservables.html">computed observables</a>. They are dead simple. They even form part of the <a href="http://knockoutjs.com/examples/helloWorld.html">Hello World example</a>. But then, the magic was not working for me. Here&rsquo;s why:</p>

<!--more-->


<p>In a nutshell <strong>computed observables</strong> are functions that are dependent on one or more other observables, and that will automatically update whenever any of these dependencies change.</p>

<script async src="//jsfiddle.net/rniemeyer/LkqTU/embed/js,html,css,result/dark/"></script>


<p>On my usecase I wanted the computed to updated only if certain condition was met. So I used a variable and a good old if.</p>

<script async src="//jsfiddle.net/jivimberg/uza8ds21/embed/js,html,css,result/dark/"></script>


<p>I also added a toggle function to be able to change the value of the <code>bindingActive</code> variable from the UI. So the <code>fullName</code> should get updated once I toggle the boolean variable. <strong>Guess what? it doesn&rsquo;t!</strong></p>

<p>Go ahead, give it a try. Turn on the toggle using the link and you&rsquo;ll notice that the message does not appear as it did on the Hello World example.</p>

<p>I spent half a day looking for an answer of what I was doing wrong. Until I decided to do what I should&rsquo;ve done in the first place. Instead of regarding some new technology as magic, I went ahead and read the documentation to actually understand how it works.</p>

<p>So here&rsquo;s how the <a href="http://knockoutjs.com/documentation/computed-dependency-tracking.html">dependency tracking algorithm</a> works according to KO documentation:</p>

<blockquote><ol>
<li>Whenever you declare a computed observable, KO immediately invokes its evaluator function to get its initial value.</li>
<li>While the evaluator function is running, KO sets up a subscription to any observables (including other computed observables) that the evaluator reads. The subscription callback is set to cause the evaluator to run again, looping the whole process back to step 1 (disposing of any old subscriptions that no longer apply).</li>
<li>KO notifies any subscribers about the new value of your computed observable.</li>
</ol>
</blockquote>

<p>Notice what&rsquo;s going on? Since <code>bindingActive</code> initial value is <em>false</em> the tracking algorithm does not see the observables on it&rsquo;s first past. Therefore the <strong>computed observable is not suscribed to update when any of the observables change!</strong></p>

<h3>How can we fix this?</h3>

<p>Well a simple solution would be to define the toggle as an observable too. That way the computed observable suscribes to the toggle var observable and it gets recomputed when the variable changes.</p>

<p>Note that afterwards the step 2 of the tracking algorithm is designed to recognized the new observables that it missed the first time. That&rsquo;s quite nice! Only in our case since no observable was seen at all the computed observable was never updated.</p>

<p>Here&rsquo;s how such solution would look like:</p>

<script async src="//jsfiddle.net/jivimberg/ymucehk2/embed/js,html,css,result/dark/"></script>


<p>Another way of solving this issue would be to call the observables for <code>firstName</code> and <code>lastName</code> outside the if. That works too, but I like the other approach better.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using PowerMock + TestNG to Mock a Static Class]]></title>
    <link href="http://jivimberg.github.io/blog/2016/04/03/using-powermock-plus-testng-to-mock-a-static-class/"/>
    <updated>2016-04-03T08:38:47-07:00</updated>
    <id>http://jivimberg.github.io/blog/2016/04/03/using-powermock-plus-testng-to-mock-a-static-class</id>
    <content type="html"><![CDATA[<p>Ôøº
This week I needed to test a class that depended on a method from an static class. I saw we were using <a href="https://github.com/jayway/powermock" title="PowerMock">PowerMock</a> and thought to myself: <em>‚ÄúWell this sounds pretty common, I bet it‚Äôs easy to accomplish‚Äù</em>. But of course I ran into half a dozen issues before I was able to make it work. Here‚Äôs my two cents to make your experience easier than mine.</p>

<!--more-->


<h2>Setup</h2>

<p>Let‚Äôs start with the ingredients. To mock static methods you‚Äôll need a couple of libraries:</p>

<ul>
<li><a href="http://easymock.org/">EasyMock</a> for the mocking<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></li>
<li><a href="https://github.com/jayway/powermock">PowerMock</a></li>
<li><a href="http://testng.org/">TestNG</a> for the test</li>
</ul>


<p>When choosing your library version you‚Äôll need to make sure <strong>PowerMock</strong> and <strong>TestNG</strong> versions are compatible. You can do so by comparing your versions with the ones specified <a href="https://github.com/jayway/powermock/wiki/TestNG_usage">here</a>.</p>

<p>Also, if you‚Äôre not using <strong>Maven</strong> to include PowerMock in your project make sure you also add it‚Äôs dependencies. You‚Äôll find a zip file containing everything you need <a href="https://github.com/jayway/powermock/wiki/GettingStarted">here</a>.</p>

<h2>Writing the test</h2>

<p>To have the test working you‚Äôll need to do 3 things:</p>

<ol>
<li>Configure <strong>TestNG</strong> to use the PowerMock object factory</li>
<li>Use <code>@PrepareForTest</code> annotation to prepare the static class</li>
<li><strong>Mock</strong> the static class method</li>
<li><strong>Write the rest</strong> of the test</li>
</ol>


<p>Let‚Äôs go one by one:</p>

<h4>1. Configure TestNG to use the PowerMock object factory</h4>

<p>There are a bunch of ways of doing this, namely:</p>

<ul>
<li>Configure it on the <code>suite.xml</code> file</li>
<li>Extending your test class with <code>PowerMockTestCase</code></li>
<li>Or by adding a method like this to your test</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@ObjectFactory</span>
</span><span class='line'><span class="kd">public</span> <span class="n">IObjectFactory</span> <span class="nf">getObjectFactory</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">powermock</span><span class="o">.</span><span class="na">modules</span><span class="o">.</span><span class="na">testng</span><span class="o">.</span><span class="na">PowerMockObjectFactory</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I choose to go with the latter because I don‚Äôt use the <code>suite.xml</code> file and adding an annotated method is less restrictive than extending a class. But feel free to use whatever works for you.</p>

<h4>2. @PrepareForTest</h4>

<p>You‚Äôll need to prepare your static class for mocking. You can do so with the <code>@PrepareForTest</code> annotation like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@PrepareForTest</span><span class="o">(</span><span class="n">StaticHelper</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyTest</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that you can pass an array of classes to the annotation if you need to prepare multiple classes.</p>

<h4>3. Mocking</h4>

<p>Now you‚Äôre ready to mock the static method like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// mocking static method</span>
</span><span class='line'>  <span class="n">PowerMock</span><span class="o">.</span><span class="na">mockStatic</span><span class="o">(</span><span class="n">StaticHelper</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>  <span class="n">EasyMock</span><span class="o">.</span><span class="na">expect</span><span class="o">(</span><span class="n">StaticHelper</span><span class="o">.</span><span class="na">doSomething</span><span class="o">()).</span><span class="na">andReturn</span><span class="o">(</span><span class="err">‚Äú</span><span class="n">hello</span> <span class="n">world</span><span class="err">‚Äù</span><span class="o">)).</span><span class="na">anyTimes</span><span class="o">();</span>
</span><span class='line'>  <span class="n">PowerMock</span><span class="o">.</span><span class="na">replay</span><span class="o">(</span><span class="n">StaticHelper</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>4. Writing the rest</h4>

<p>Ok let‚Äôs put everything together and write the rest of the test</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@PrepareForTest</span><span class="o">(</span><span class="n">StaticHelper</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@ObjectFactory</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">IObjectFactory</span> <span class="nf">getObjectFactory</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">powermock</span><span class="o">.</span><span class="na">modules</span><span class="o">.</span><span class="na">testng</span><span class="o">.</span><span class="na">PowerMockObjectFactory</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Test</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// mocking static method</span>
</span><span class='line'>      <span class="n">PowerMock</span><span class="o">.</span><span class="na">mockStatic</span><span class="o">(</span><span class="n">StaticHelper</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>      <span class="n">EasyMock</span><span class="o">.</span><span class="na">expect</span><span class="o">(</span><span class="n">StaticHelper</span><span class="o">.</span><span class="na">doSomething</span><span class="o">()).</span><span class="na">andReturn</span><span class="o">(</span><span class="err">‚Äú</span><span class="n">hello</span> <span class="n">world</span><span class="err">‚Äù</span><span class="o">)).</span><span class="na">anyTimes</span><span class="o">();</span>
</span><span class='line'>      <span class="n">PowerMock</span><span class="o">.</span><span class="na">replay</span><span class="o">(</span><span class="n">StaticHelper</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>  
</span><span class='line'>      <span class="c1">// test</span>
</span><span class='line'>      <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="err">‚Äú</span><span class="n">hello</span> <span class="n">world</span><span class="err">‚Äù</span> <span class="err">‚Äù</span> <span class="n">StaticHelper</span><span class="o">.</span><span class="na">doSomething</span><span class="o">());</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course this is an oversimplified example. The cool thing about mocking static methods is that <strong>the static call you may need to mock may be hidden under several layers of abstraction</strong>. Using this approach you are able to mock the static call and test your classes without changing a single line of production code.</p>

<h2>Some things to watch out for</h2>

<p>There are a few things to keep in mind when initializing the mock:</p>

<ol>
<li>You cannot create mocks during <strong>field initialization</strong>.</li>
<li>You cannot create mocks inside <strong>before static methods</strong>.</li>
</ol>


<p>Finally I also run into the following error when running my test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">VerifyError</span><span class="o">:</span> <span class="n">Expecting</span> <span class="n">a</span> <span class="n">stackmap</span> <span class="n">frame</span> <span class="n">at</span> <span class="n">branch</span> <span class="n">target</span> <span class="mi">71</span> <span class="n">in</span> <span class="n">method</span> <span class="n">com</span><span class="o">.</span><span class="na">abc</span><span class="o">.</span><span class="na">domain</span><span class="o">.</span><span class="na">myPackage</span><span class="o">.</span><span class="na">MyClass$JaxbAccessorM_getDescription_setDescription_java_lang_String</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Ljava</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">Object</span><span class="o">;)</span><span class="n">Ljava</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">Object</span><span class="o">;</span> <span class="n">at</span> <span class="n">offset</span> <span class="mi">20</span><span class="n">_</span>
</span></code></pre></td></tr></table></div></figure>


<p>Turns out that, as explained <a href="http://stackoverflow.com/questions/15122890/java-lang-verifyerror-expecting-a-stackmap-frame-at-branch-target-jdk-1-7">here</a> Java 7 introduced a stricter verification and changed the class format. The byte code generation library PowerMock uses is generating code that does not comply with the new verification. But worry not, <strong>this validation can be disabled</strong> by passing <code>-noverify</code> as argument to the JVM.</p>

<p>If you&rsquo;re running you&rsquo;re using Maven to run your tests remember to add the argument to your plugin configuration.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>This guide uses <strong>EasyMock</strong> but you can also use <strong>Mockito</strong><a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Be a Leader (HTWFAIP - Part 4)]]></title>
    <link href="http://jivimberg.github.io/blog/2015/06/15/be-a-leader-htwfaip-part-4/"/>
    <updated>2015-06-15T07:37:31-07:00</updated>
    <id>http://jivimberg.github.io/blog/2015/06/15/be-a-leader-htwfaip-part-4</id>
    <content type="html"><![CDATA[<p>Last installment of the <a href="http://localhost:4000/blog/categories/htwfaip/">series</a>. 9 Tips to become the leader you&rsquo;d like to follow.</p>

<!-- more -->


<h3>Begin with praise and honest appreciation</h3>

<p>It is always easier to listen to unpleasant things after we have heard some praise of our good points. This is also sometimes refered as the <a href="http://lifehacker.com/297247/give-constructive-criticism">&ldquo;sandwich rule&rdquo;</a>.</p>

<p><img class="center" src="http://jivimberg.github.io/images/posts/2015-06-15/SandwichRule.jpg" width="250" title="'Sandwich Rule'" ></p>

<h3>How to Criticize: Call attention to people‚Äôs mistakes indirectly</h3>

<p>Change the word &lsquo;but&rsquo; to &lsquo;and&rsquo;. For example: a man carefully polished a sermon and showed it to his wife, instead of talking about its many faults, she said she thought it would be a great article for some journal. Be subtle about criticism.</p>

<h3>Talk about your own mistakes before criticizing</h3>

<p>In order to build rapport with the person you are criticising, start by talking about your own mistakes. You can use phrases like: &ldquo;When I was your age, I too struggled with&hellip;&rdquo; or &ldquo;When I was at your level of experience, I too thought that&hellip;&rdquo;.</p>

<h3>Ask questions instead of giving direct orders</h3>

<p>Gave suggestions, not orders. Let people do things for themselves and make their own mistakes. Asking questions not only makes an order more palatable; it often stimulates the creativity of the persons whom you ask. <strong>People are more likely to accept an order if they have had a part in the decision that caused the order to be issued.</strong></p>

<h3>Let the other person save face</h3>

<p>A few minutes‚Äô thought, a considerate word or two, or a genuine understanding of the other person‚Äôs attitude can go a long way to alleviating the sting of criticism. Antoine de Saint-Exupery once said: <em>‚ÄúI have no right to say or do anything that diminishes a man in his own eyes. What matters is not what I think of him, but what he thinks of himself. Hurting a man in his dignity is a crime.‚Äù</em></p>

<h3>Praise every improvement, no matter how slight</h3>

<p>Take every chance you&rsquo;ve got to sincerly praise someone. Everybody likes to be praised, but when praise is specific, it comes across as sincere ‚Äì not something the other person may be saying just to make one feel good. <strong>Nobody wants flattery!</strong></p>

<h3>Give the person a fine reputation to live up to</h3>

<p>In short, if you want to improve a person in a certain respect, act as though that particular trait were already one of his or her outstanding characteristics. Give them a fine reputation to live up to, and they will make prodigious efforts rather than see you disillusioned.</p>

<h3>Make a fault seem easy to correct</h3>

<p>Make the thing seem easy to do, let the other person know that you have faith in his ability to do it, that he has an undeveloped flair for it ‚Äì and he will practise until the dawn comes in the window in order to excel.</p>

<h3>Make the other person happy about doing what you suggest</h3>

<p>When you make your request, put it in a form that will convey to the other person the idea that he personally will benefit. <em>&lsquo;He had a delightful way of putting things; he created the impression that by accepting this great honour I would be doing him a favour.&rsquo;</em></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Win People to Your Way of Thinking (HTWFAIP - Part 3)]]></title>
    <link href="http://jivimberg.github.io/blog/2014/12/21/win-people-to-your-way-of-thinking-htwfaip-part-3/"/>
    <updated>2014-12-21T18:53:16-08:00</updated>
    <id>http://jivimberg.github.io/blog/2014/12/21/win-people-to-your-way-of-thinking-htwfaip-part-3</id>
    <content type="html"><![CDATA[<p>Third post of the <a href="http://localhost:4000/blog/categories/htwfaip/">series</a>. Today: some advice on how to convince people to your way of thinking. This is a long, but juicy post.</p>

<!-- more -->


<h3>1. You can‚Äôt win an argument</h3>

<p>If you argue and rankle and contradict, you may achieve a victory sometimes; but it will be an empty victory because you will never get your opponent‚Äôs good will (&ldquo;You have made him feel inferior. You have hurt his pride. He will resent your triumph.&rdquo;). Distrust your first instinctive impression. Our first natural reaction in a disagreeable situation is to be defensive. Be careful. Listen first. Give your opponents a chance to talk. Let them finish. Do not resist, defend or debate. This only raises barriers. Try to build bridges of understanding. Don‚Äôt build higher barriers of misunderstanding. Look for areas of agreement. When you have heard your opponents out, dwell first on the points and areas on which you agree. Be honest. Look for areas where you can admit error and say so. Apologize for your mistakes. It will help disarm your opponents and reduce defensiveness. Thank your opponents sincerely for their interest. Anyone who takes the time to disagree with you is interested in the same things you are. Think of them as people who really want to help you, and you may turn your opponents into friends.</p>

<h3>2. Show respect for the other person‚Äôs opinions</h3>

<p>Never say, ‚ÄúYou‚Äôre wrong.‚Äù: Never begin by announcing ‚ÄòI am going to prove so-and-so to you.‚Äô That‚Äôs bad. Do it so subtly, so adroitly, that no one will feel that you are doing it. You will never get into trouble by admitting that you may be wrong. That will stop all argument and inspire your opponent to be just as fair and open and broad-minded as you are. It will make him want to admit that he, too, may be wrong.</p>

<h3>3. When wrong, admit it quickly and emphatically</h3>

<p>Say about yourself all the derogatory things you know the other  person is thinking or wants to say‚Äîand say them before that person has a chance to. The chances are a hundred to one that a generous, forgiving attitude will be taken and your mistakes will be minimised.</p>

<h3>4. Begin in a friendly way</h3>

<p>Gentleness and friendliness were always stronger than fury and force.</p>

<h3>5. Get the other person saying ‚Äúyes, yes‚Äù</h3>

<p>Begin by emphasising ‚Äì and keep on emphasising ‚Äì the things on which you agree. Keep emphasising, if possible, that you are both striving for the same end and that your only difference is one of method and not of purpose. The skillful speaker gets, at the outset, a number of ‚ÄòYes‚Äô responses.</p>

<h3>6. Let the other person do lots of the talking</h3>

<p>Let the other people talk themselves out. They know more about their business and problems than you do. So ask them questions. Let them tell you a few things. Almost every successful person likes to reminisce about his early struggles.</p>

<h3>7. Let the other person feel ownership of the idea</h3>

<p>No one likes to feel that he or she is being sold something or told to do a thing. We much prefer to feel that we are buying of our own accord or acting on our own ideas. We like to be consulted about our wishes, our wants, our thoughts.</p>

<h3>8. Try honestly to see things from the other  person‚Äôs point of view</h3>

<p>Success in dealing with people depends on a sympathetic grasp of the other person‚Äôs viewpoint. ‚ÄòI would rather walk the sidewalk in front of a person‚Äôs office for two hours before an interview,‚Äô said Dean Donham of the Harvard business school, ‚Äòthan step into that office without a perfectly clear idea of what I was going to say and what that person ‚Äì from my knowledge of his or her interests and motives ‚Äì was likely to answer.‚Äô</p>

<h3>9. Be sympathetic towards the other person‚Äôs ideas and desires</h3>

<p>The magic words: ‚ÄúI don‚Äôt blame you one iota for feeling as you do. If I were you I‚Äôd undoubtedly feel the same.‚Äù And mean it!</p>

<h3>10. Appeal to the nobler motives</h3>

<p>If you have no other evidence, assume that a customer is honest, truthful, and willing to pay the charges if they are convinced that they are correct.Even those who aren‚Äôt naturally honest will often react well if you show that you consider them to be honest and fair.</p>

<h3>11. Dramatize your idea</h3>

<p>Merely stating a truth isn‚Äôt enough. The truth has to be made vivid, interesting, dramatic. You have to use showmanship.</p>

<h3>12. Throw down a challenge</h3>

<p>People love the work they are doing, and being great at it.Charles Schwab: ‚ÄúThe way to get things done is to stimulate competition. I do not mean in a sordid, money-getting way, but in the desire to excel.‚Äù</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Make People Like You (HTWFAIP - Part 2)]]></title>
    <link href="http://jivimberg.github.io/blog/2014/11/15/how-to-make-people-like-you-htwfaip-part-2/"/>
    <updated>2014-11-15T18:57:40-08:00</updated>
    <id>http://jivimberg.github.io/blog/2014/11/15/how-to-make-people-like-you-htwfaip-part-2</id>
    <content type="html"><![CDATA[<p>Second post of the <a href="http://localhost:4000/blog/categories/htwfaip/">series</a> on the book <a href="http://www.amazon.com/How-Win-Friends-Influence-People/dp/0671027034">&ldquo;How to Win Friends and Influence People&rdquo;</a> by <a href="http://en.wikipedia.org/wiki/Dale_Carnegie">Dale Carnegie</a>. I know, <strong>How to make people like you</strong> sounds soooo lame, but stick with me, this is a good chapter.</p>

<!-- more -->


<h3>1. Become genuinely interested in other people</h3>

<p>You can make more friends in two months by becoming interested in other people than you can in two years by trying to get other people interested in you.</p>

<h3>2. Smile!</h3>

<p>Like a dog, show that you are happy to see people. Smile even when talking on the phone. Happiness doesn‚Äôt depend on outward conditions. It depends on inner conditions. ‚ÄòA man without a smiling face must not open a shop.‚Äô</p>

<h3>3. Remember that a person‚Äôs name is to that person the sweetest sound in any language</h3>

<p>Napoleon‚Äôs advice on remembering names: If he didn‚Äôt get the name distinctly, he said, ‚ÄúSo sorry. I didn‚Äôt get the name clearly.‚Äù Then, if it was an unusual name, he would say, ‚ÄúHow is it spelled?‚Äù During the conversation, he took the trouble to repeat the name several times, and tried to associate it in his mind with the person‚Äôs features, expression and general appearance.</p>

<h3>4. Be a good listener</h3>

<p>Encourage others to talk about themselves: &ldquo;She didn‚Äôt want to hear me talk about my travels. All she wanted was an interested listener, so she could expand her ego and tell about where she had been.&rdquo; Exclusive attention to the person who is speaking to you is very important. Nothing else is so flattering as that. Ask questions that the other  person will enjoy answering. A friend often doesn‚Äôt want advice, but just a friendly, sympathetic listener. A person‚Äôs toothache means more to that person than a famine in China which kills a million people, think of that the next time you start a conversation.</p>

<h3>5. Talk in terms of the other person‚Äôs interests</h3>

<p>Whenever Roosevelt expected a visitor, he sat up late the night before, reading up on the subject in which he knew his guest was particularly interested.</p>

<h3>6. Make the other person feel important‚Äîand do it sincerely</h3>

<p>Little phrases such as ‚ÄòI‚Äôm sorry to trouble you,‚Äô ‚ÄòWould you be so kind as to ‚Äì ?‚Äô ‚ÄòWon‚Äôt you please?‚Äô ‚ÄòWould you mind?‚Äô ‚ÄòThank you‚Äô ‚Äì little courtesies like these oil the cogs of the monotonous grind of everyday life ‚Äì and incidentally, they are the hallmark of good breeding. The unvarnished truth is that almost all the people you meet feel themselves superior to you in some way, and a sure way to their hearts is to let them realise in some subtle way that you realise their importance, and recognise it sincerely. ‚ÄòTalk to people about themselves and they will listen for hours.‚Äô</p>
]]></content>
  </entry>
  
</feed>
